<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZfP Operator Audit - Schaeffler</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
            color: #333;
            background-color: #f5f5f5;
            padding: 6px;
            font-size: 14px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        header {
            text-align: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid #2c3e50;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 4px;
            font-size: 2em;
        }
        .subtitle {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 8px;
        }

        /* MODAL F√úR IPHONE FIX */
        .custom-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .custom-modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            text-align: center;
        }
        .custom-modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }
        .custom-modal-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            min-width: 80px;
        }
        .custom-modal-btn.confirm {
            background: #27ae60;
            color: white;
        }
        .custom-modal-btn.cancel {
            background: #e74c3c;
            color: white;
        }

        /* AUDIT AUSWAHL */
        .audit-selection {
            text-align: center;
            margin: 15px 0;
        }
        .audit-selection h2 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.1em;
        }
        .audit-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
        }
        .audit-btn {
            padding: 12px 8px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }
        .audit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
        }
        .audit-btn.wirbelstrom { background: #3498db; }
        .audit-btn.magnetpulver { background: #e74c3c; }
        .audit-btn.nital { background: #2ecc71; }
        .audit-btn.ultraschall { background: #9b59b6; }
        .audit-btn .btn-icon {
            font-size: 1.6em;
            margin-bottom: 6px;
        }
        .audit-btn .btn-progress {
            margin-top: 4px;
            font-size: 0.7em;
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 8px;
            min-width: 35px;
        }
        .audit-btn.disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .audit-btn.disabled:hover {
            transform: none;
            box-shadow: none;
        }

        /* CONTROLS */
        .controls-row-1 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
            margin-bottom: 5px;
        }
        
        .controls-row-2 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
            margin-bottom: 8px;
        }
        
        .controls-row-1 button,
        .controls-row-2 button {
            padding: 5px 4px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.65em;
            height: 32px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }
        
        .btn-back { background: #7f8c8d; color: white; }
        .btn-export { background: #27ae60; color: white; }
        .btn-audit-load { background: #3498db; color: white; }
        .btn-authorization { background: #9b59b6; color: white; }
        .btn-report { background: #f39c12; color: white; }
        .btn-desktop { background: #95a5a6; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-success { background: #27ae60; color: white; }
        button:hover { opacity: 0.9; }

        /* NEUE STATUSLEISTE MIT FORTSCHRITTSBALKEN */
        .audit-status {
            margin-bottom: 6px;
            font-size: 0.9em;
            background: #f8f9fa;
            padding: 6px; 
            border-radius: 4px;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .status-text {
            font-weight: 600;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .status-text strong {
            color: #3498db;
        }
        
        .progress-container {
            flex: 1;
            min-width: 200px;
            max-width: 400px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 5px;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            color: #666;
            font-weight: bold;
        }

        /* KOPFDATEN SECTION */
        .header-section {
            background: #f8f9fa;
            border: 1px solid #3498db;
            border-radius: 5px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .header-section h3 {
            color: #2c3e50;
            margin: 0;
            padding: 8px 10px;
            text-align: center;
            font-size: 0.85em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .toggle-header-btn {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            font-size: 0.85em;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            min-width: 60px;
        }
        .header-content {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        .header-content.collapsed {
            max-height: 0;
            padding: 0 !important;
            overflow: hidden;
        }
        .header-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 8px;
            padding: 10px;
        }
        .header-group {
            background: white;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .header-group h4 {
            color: #2c3e50;
            margin-bottom: 5px;
            border-bottom: 1px solid #ecf0f1;
            padding-bottom: 3px;
            font-size: 0.9em;
        }
        .header-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-family: inherit;
            font-size: 0.8em;
            margin-bottom: 6px;
            box-sizing: border-box;
            -webkit-appearance: none;
            appearance: none;
        }
        .header-input:last-child {
            margin-bottom: 0;
        }

        /* MOBILE HEADER - KOMPAKT */
        .mobile-header-section.collapsed {
            padding: 2px;
        }
        .mobile-header-section.collapsed h3 {
            padding: 4px 6px;
            font-size: 0.75em;
            min-height: 24px;
        }

        /* FRAGEN UND SECTIONS */
        .section {
            margin-bottom: 15px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            overflow: hidden;
        }
        .section-header {
            background: #34495e;
            color: white;
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        .section-header:hover {
            background: #2c3e50;
        }
        .section-header h2 { 
            margin: 0; 
            font-size: 1em;
        }
        .section-header span {
            transition: transform 0.3s;
        }
        .section.expanded .section-header span {
            transform: rotate(90deg);
        }
        .section-content {
            padding: 10px;
            display: none;
        }
        .section.expanded .section-content { 
            display: block; 
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .question {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #95a5a6;
            -webkit-tap-highlight-color: transparent;
        }
        .question.ok { border-left-color: #27ae60; background: #f0fff4; }
        .question.not-ok { border-left-color: #e74c3c; background: #fff0f0; }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        .question-text { 
            flex: 1; 
            font-weight: 500;
            font-size: 1.25em;
            line-height: 1.4;
        }
        .question-id {
            background: #3498db;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 1.25em;
            margin-left: 8px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .english-translation {
            font-style: italic;
            color: #666;
            font-size: 1.0em;
            margin-top: 5px;
            margin-bottom: 10px;
            padding-left: 10px;
            border-left: 2px solid #ddd;
        }
        
        /* Ja/Nein Buttons */
        .verdict-options {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .verdict-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            -webkit-tap-highlight-color: transparent;
        }
        .verdict-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .verdict-btn.ok {
            background: #e8f6f3;
            color: #27ae60;
            border: 2px solid #27ae60;
        }
        .verdict-btn.ok.selected {
            background: #27ae60;
            color: white;
        }
        .verdict-btn.not-ok {
            background: #ffebee;
            color: #e74c3c;
            border: 2px solid #e74c3c;
        }
        .verdict-btn.not-ok.selected {
            background: #e74c3c;
            color: white;
        }
        
        .comment-section {
            margin-bottom: 10px;
        }
        .comment-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
            font-size: 0.85em;
        }
        .comment {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
            font-size: 0.85em;
            box-sizing: border-box;
        }
        
        /* Bild-Upload */
        .image-upload-section {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px dashed #3498db;
        }
        .image-upload-section h4 {
            color: #2c3e50;
            margin-bottom: 6px;
            font-size: 0.85em;
        }
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin-bottom: 5px;
        }
        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        .file-input-label {
            display: inline-block;
            padding: 5px 12px;
            background: #3498db;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 500;
        }
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
        }
        .image-preview {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .remove-image {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #e74c3c;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 0.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        
        /* GESAMTERGEBNIS */
        .final-result {
            text-align: center;
            margin: 10px 0;
            padding: 12px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 0.9em;
            display: none;
        }
        .final-result.passed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .final-result.failed {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .final-result.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        /* MOBILE ANSICHT */
        .mobile-view { 
            display: none; 
        }
        .desktop-view { 
            display: block; 
        }

        /* MOBILE NAVIGATION */
        .mobile-nav {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            border-top: 1px solid #ddd;
        }
        .mobile-nav button {
            padding: 10px 15px;
            font-size: 0.8em;
            min-width: 80px;
            border: none;
            border-radius: 4px;
            background: #95a5a6;
            color: white;
            cursor: pointer;
        }
        #mobileCounter {
            font-size: 0.9em;
            padding: 0 15px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }

        /* KATEGORIEN-BUTTONS F√úR MOBILE */
        .mobile-section-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 10px;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
        }
        .section-btn { 
            flex: 1; 
            min-width: 60px; 
            font-size: 0.7em;
            padding: 6px 4px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border: none;
            border-radius: 3px;
            background: #3498db;
            color: white;
            cursor: pointer;
        }
        .section-btn.active {
            background: #2c3e50;
            font-weight: bold;
        }

        /* BERICHTSANZEIGE - OPTIMIERT F√úR A4 (IMMER HELL) */
        .report-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
        }
        
        .report-container {
            background: white !important;
            color: #000 !important;
            width: 95%;
            max-width: 800px;
            margin: 0 auto 20px auto;
            border-radius: 0;
            font-family: 'Arial', sans-serif;
            position: relative;
            padding: 20px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.5);
            height: auto;
            min-height: auto;
        }
        
        /* DRUCK- UND SCHLIE√üEN-BUTTONS */
        .report-action-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 1002;
        }
        
        .report-action-btn {
            background: #3498db;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        
        .report-action-btn:hover {
            opacity: 1;
        }
        
        .report-action-btn.print-btn {
            background: #27ae60;
        }
        
        .report-action-btn.close-btn {
            background: #e74c3c;
        }
        
        .report-header {
            position: relative;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
            margin-bottom: 15px;
            text-align: center;
            height: auto;
            min-height: 10mm;
            max-height: 15mm;
        }
        
        .report-header h2 {
            font-size: 16px !important;
            margin: 0 0 2px 0;
            color: #000 !important;
            line-height: 1.2;
        }
        
        .company-info {
            font-size: 11px;
            margin: 1px 0;
            color: #333 !important;
        }
        
        /* Tabellen - KOMPAKTER */
        .person-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 10px;
        }
        
        .person-table th,
        .person-table td {
            border: 1px solid #000;
            padding: 6px;
            vertical-align: top;
        }
        
        .person-table th {
            background: #f0f0f0 !important;
            font-weight: bold;
            text-align: left;
        }
        
        .details-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 10px;
        }
        
        .details-table td {
            border: 1px solid #000;
            padding: 5px 6px;
            vertical-align: middle;
        }
        
        .details-table td:first-child {
            font-weight: bold;
            width: 25%;
            background: #f9f9f9 !important;
        }
        
        /* Ergebnisse - KOMPAKTER */
        .results-section {
            margin: 15px 0;
        }
        
        .report-section-header {
            font-size: 12px;
            font-weight: bold;
            margin: 10px 0 5px 0;
            padding-bottom: 3px;
            border-bottom: 1px solid #000;
        }
        
        .question-item {
            margin: 4px 0;
            padding: 5px;
            font-size: 10px;
            line-height: 1.3;
        }
        
        .question-item.ok {
            border-left: 2px solid #00a000;
            background: #f0fff0 !important;
        }
        
        .question-item.not-ok {
            border-left: 2px solid #ff0000;
            background: #fff0f0 !important;
        }
        
        .question-id {
            font-weight: bold;
            color: #000 !important;
            font-size: 10px;
        }
        
        .question-comment {
            font-style: italic;
            color: #666;
            margin-left: 8px;
            font-size: 9px;
        }
        
        /* Unterschriften - PROFESSIONELL WIE IM ORIGINAL */
        .signature-area {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #000;
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }
        
        .signature-box {
            flex: 1;
            text-align: center;
            min-width: 45%;
        }
        
        .signature-line {
            margin-top: 50px;
            min-height: 40px;
        }
        
        /* AUTORISIERUNGS-BERICHT */
        .authorization-header {
            position: relative;
            text-align: center;
            border-bottom: 3px solid #000;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .authorization-header h1 {
            font-size: 24px;
            margin: 0 0 10px 0;
            color: #000 !important;
        }
        
        .authorization-info {
            margin: 15px 0;
            padding: 10px;
            border: 1px solid #ddd;
            background: #f9f9f9;
        }
        
        .authorization-info p {
            margin: 5px 0;
            font-size: 14px;
        }
        
        .authorization-text-box {
            border: 2px solid #000;
            padding: 20px;
            margin: 20px 0;
            font-size: 14px;
            line-height: 1.5;
            background: #f9f9f9 !important;
            min-height: 100px;
        }
        
        .authorization-details {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ccc;
            background: #fff;
        }
        
        .authorization-details p {
            margin: 8px 0;
            font-size: 13px;
        }
        
        /* Autoriserungs-Unterschriften - IDENTISCH ZUM BERICHTSFORMULAR */
        .authorization-signatures {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #000;
            display: flex;
            justify-content: space-between;
            gap: 30px;
        }
        
        .authorization-signature-field {
            flex: 1;
            text-align: center;
            min-width: 45%;
        }
        
        .authorization-signature-line {
            margin-top: 50px;
            padding-top: 8px;
            min-height: 40px;
        }
        
        .authorization-stamp-box {
            text-align: center;
            margin: 30px 0;
            padding: 15px;
            border: 3px solid #000;
            border-radius: 10px;
            background: #fff;
            display: inline-block;
            margin-left: 50%;
            transform: translateX(-50%);
        }
        
        /* ANSICHTS-STEUERUNG */
        .audit-content { display: none; }
        .audit-content.active { display: block; }
        .audit-selection { display: none; }
        .audit-selection.active { display: block; }

        /* FOOTER */
        footer {
            text-align: center;
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid #ecf0f1;
            color: #7f8c8d;
            font-size: 0.85em;
        }
        .creator-info {
            font-weight: bold;
            color: #2c3e50;
            margin-top: 4px;
            font-size: 0.9em;
        }
        .version-info {
            margin-top: 2px;
            font-size: 0.8em;
            color: #7f8c8d;
        }

        /* DARK MODE */
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #121212;
                color: #e0e0e0;
            }
            
            .container {
                background: #1e1e1e;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            }
            
            header {
                border-bottom-color: #444;
            }
            
            h1 {
                color: #ffffff;
            }
            
            .subtitle {
                color: #b0b0b0;
            }
            
            /* MODAL DARK MODE */
            .custom-modal-content {
                background: #2d2d2d;
                color: #e0e0e0;
            }
            
            /* AUDIT BUTTONS DARK MODE */
            .audit-btn.wirbelstrom { 
                background: #2980b9;
                color: white;
            }
            .audit-btn.magnetpulver { 
                background: #c0392b;
                color: white;
            }
            .audit-btn.nital { 
                background: #27ae60;
                color: white;
            }
            .audit-btn.ultraschall { 
                background: #8e44ad;
                color: white;
            }
            .audit-btn.disabled {
                opacity: 0.4;
                background: #555;
            }
            
            .audit-btn .btn-progress {
                background: rgba(255,255,255,0.1);
            }
            
            /* CONTROLS DARK MODE */
            .btn-back { background: #666; color: white; }
            .btn-export { background: #219653; color: white; }
            .btn-audit-load { background: #2980b9; color: white; }
            .btn-authorization { background: #8e44ad; color: white; }
            .btn-report { background: #d35400; color: white; }
            .btn-desktop { background: #7f8c8d; color: white; }
            .btn-danger { background: #c0392b; color: white; }
            .btn-success { background: #27ae60; color: white; }
            
            /* STATUSLEISTE DARK MODE */
            .audit-status {
                background: #2d2d2d;
                border-color: #444;
            }
            
            .status-text {
                color: #ffffff;
            }
            
            .status-text strong {
                color: #3498db;
            }
            
            .progress-bar {
                background: #333;
            }
            
            .progress-text {
                color: #b0b0b0;
            }
            
            /* KOPFDATEN SECTION DARK MODE */
            .header-section {
                background: #2d2d2d;
                border-color: #2980b9;
            }
            
            .header-section h3 {
                color: #ffffff !important;
                font-weight: 600;
            }
            
            .header-group {
                background: #252525;
                border-color: #444;
            }
            
            .header-group h4 {
                color: #ffffff;
                border-bottom-color: #444;
            }
            
            .header-input {
                background: #333;
                border-color: #555;
                color: #e0e0e0;
            }
            
            .header-input::placeholder {
                color: #888;
            }
            
            /* FRAGEN UND SECTIONS DARK MODE */
            .section {
                border-color: #444;
            }
            
            .section-header {
                background: #2c3e50;
            }
            
            .section-header:hover {
                background: #34495e;
            }
            
            .question {
                background: #252525;
                border-left-color: #666;
            }
            
            .question.ok { 
                border-left-color: #27ae60; 
                background: rgba(39, 174, 96, 0.1);
            }
            
            .question.not-ok { 
                border-left-color: #e74c3c; 
                background: rgba(231, 76, 60, 0.1);
            }
            
            .question-id {
                background: #3498db;
                color: white !important;
            }
            
            .english-translation {
                color: #b0b0b0;
                border-left-color: #666;
            }
            
            /* JA/NEIN BUTTONS DARK MODE */
            .verdict-btn.ok {
                background: rgba(39, 174, 96, 0.1);
                color: #2ecc71;
                border-color: #27ae60;
            }
            
            .verdict-btn.ok.selected {
                background: #27ae60;
                color: white;
            }
            
            .verdict-btn.not-ok {
                background: rgba(231, 76, 60, 0.1);
                color: #e74c3c;
                border-color: #e74c3c;
            }
            
            .verdict-btn.not-ok.selected {
                background: #e74c3c;
                color: white;
            }
            
            /* KOMMENTARFELDER DARK MODE */
            .comment-label {
                color: #ffffff;
            }
            
            .comment {
                background: #333;
                border-color: #555;
                color: #e0e0e0;
            }
            
            .comment::placeholder {
                color: #888;
            }
            
            /* BILD-UPLOAD DARK MODE */
            .image-upload-section {
                background: rgba(52, 152, 219, 0.05);
                border-color: #3498db;
            }
            
            .image-upload-section h4 {
                color: #ffffff;
            }
            
            .file-input-label {
                background: #2980b9;
                color: white;
            }
            
            .image-preview-item {
                border-color: #666;
                background: #333;
            }
            
            .remove-image {
                background: #c0392b;
                color: white;
            }
            
            /* GESAMTERGEBNIS DARK MODE */
            .final-result.passed {
                background: rgba(39, 174, 96, 0.2);
                color: #2ecc71;
                border-color: #27ae60;
            }
            
            .final-result.failed {
                background: rgba(231, 76, 60, 0.2);
                color: #ff6b6b;
                border-color: #e74c3c;
            }
            
            .final-result.warning {
                background: rgba(243, 156, 18, 0.2);
                color: #f1c40f;
                border-color: #f39c12;
            }
            
            /* MOBILE NAVIGATION DARK MODE */
            .mobile-nav {
                border-top-color: #444;
            }
            
            .mobile-nav button {
                background: #666;
                color: white;
            }
            
            #mobileCounter {
                color: #ffffff;
            }
            
            /* KATEGORIEN-BUTTONS MOBILE DARK MODE */
            .mobile-section-selector {
                background: #2d2d2d;
            }
            
            .section-btn {
                background: #2980b9;
                color: white;
            }
            
            .section-btn.active {
                background: #3498db;
                font-weight: bold;
            }
            
            /* BERICHTSANZEIGE DARK MODE - IMMER HELL BLEIBEN */
            .report-overlay {
                background: rgba(0,0,0,0.95);
            }
            
            .report-container,
            #authorizationContainer {
                background: white !important;
                color: #000 !important;
            }

            .report-action-btn {
                background: #2980b9 !important;
                color: white !important;
            }
            
            .report-action-btn.print-btn {
                background: #219653 !important;
            }
            
            .report-action-btn.close-btn {
                background: #c0392b !important;
            }
            
            .report-header h2 {
                color: #000 !important;
            }
            
            .company-info {
                color: #333 !important;
            }
            
            .person-table th {
                background: #f0f0f0 !important;
            }
            
            .details-table td:first-child {
                background: #f9f9f9 !important;
            }
            
            .question-item.ok {
                background: #f0fff0 !important;
            }
            
            .question-item.not-ok {
                background: #fff0f0 !important;
            }
            
            .question-id {
                color: #000 !important;
            }
            
            .authorization-header h1 {
                color: #000 !important;
            }
            
            .authorization-text-box {
                background: #f9f9f9 !important;
            }
            
            /* FOOTER DARK MODE */
            footer {
                border-top-color: #444;
                color: #b0b0b0;
            }
            
            .creator-info {
                color: #ffffff;
            }
            
            .version-info {
                color: #888;
            }
        }

        /* MOBILE OPTIMIERUNGEN */
        @media (max-width: 768px) {
            body {
                padding: 4px;
                font-size: 13px;
            }
            
            .container { 
                padding: 6px; 
            }
            
            .desktop-view { 
                display: none !important; 
            }
            .mobile-view { 
                display: block !important; 
            }
            
            header h1 {
                font-size: 0.9em !important;
                margin-bottom: 2px;
            }
            
            .subtitle {
                font-size: 0.8em;
                margin-bottom: 6px;
            }
            
            /* STATUSLEISTE MOBILE */
            .audit-status {
                padding: 8px;
                font-size: 0.8em;
                gap: 6px;
            }
            
            .status-header {
                flex-direction: column;
                align-items: stretch;
                gap: 6px;
            }
            
            .progress-container {
                min-width: 100%;
                max-width: 100%;
            }
            
            .controls-row-1,
            .controls-row-2 {
                grid-template-columns: repeat(4, 1fr);
                gap: 3px;
            }
            
            .controls-row-1 button,
            .controls-row-2 button {
                padding: 5px 4px;
                font-size: 0.65em;
                height: 32px;
                min-width: 0;
            }
            
            .audit-buttons {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .audit-btn {
                padding: 10px 8px;
                min-height: 70px;
                font-size: 0.85em;
                flex-direction: row;
                justify-content: flex-start;
                text-align: left;
                padding-left: 15px;
            }
            
            .audit-btn .btn-icon {
                font-size: 1.4em;
                margin-right: 10px;
                margin-bottom: 0;
            }
            
            .audit-btn .btn-progress {
                margin-left: auto;
                margin-top: 0;
                font-size: 0.7em;
            }
            
            /* MOBILE HEADER - SEHR KOMPAKT */
            .mobile-header-section.collapsed {
                padding: 0;
                margin-bottom: 5px;
                min-height: 28px;
            }
            
            .mobile-header-section.collapsed h3 {
                padding: 3px 6px;
                font-size: 0.7em;
                min-height: 24px;
                margin: 0;
            }
            
            .mobile-header-section h3 {
                padding: 5px 8px;
                font-size: 0.75em;
                min-height: 26px;
            }
            
            .toggle-header-btn {
                padding: 2px 6px;
                font-size: 0.55em;
                min-width: 50px;
            }
            
            .header-grid {
                grid-template-columns: 1fr;
            }
            
            .header-content.collapsed {
                max-height: 0;
                overflow: hidden;
            }
            
            .header-input {
                padding: 8px 10px;
                font-size: 0.9em;
                margin-bottom: 8px;
            }
            
            .header-group {
                padding: 10px;
            }
            
            .header-group h4 {
                font-size: 0.85em;
                margin-bottom: 6px;
            }
            
            .question {
                padding: 12px;
            }
            
            .question-text {
                font-size: 0.95em;
                font-weight: 600;
                line-height: 1.45;
            }
            
            .question-id {
                font-size: 0.8em;
                margin-left: 8px;
            }
            
            .english-translation {
                font-size: 0.85em;
                color: #555;
                margin-top: 8px;
                margin-bottom: 15px;
                padding-left: 10px;
                border-left: 2px solid #ddd;
            }
            
            /* OK/Nicht-OK Buttons nebeneinander */
            .verdict-options {
                flex-direction: row !important;
                gap: 8px;
                margin-bottom: 12px;
            }
            
            .verdict-btn {
                flex: 1;
                padding: 8px 6px;
                font-size: 0.85em;
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            /* Kommentarfeld kleiner */
            .comment-section {
                margin-bottom: 10px;
            }
            
            .comment {
                min-height: 50px !important;
                padding: 8px;
                font-size: 0.85em;
                line-height: 1.3;
            }
            
            .comment-label {
                margin-bottom: 4px;
                font-size: 0.8em;
            }
            
            /* Bild-Upload Bereich kompakter */
            .image-upload-section {
                padding: 10px;
                margin-top: 12px;
            }
            
            .image-upload-section h4 {
                font-size: 0.8em;
                margin-bottom: 6px;
            }
            
            .file-input-label {
                padding: 6px 10px;
                font-size: 0.75em;
            }
            
            .image-preview-container {
                gap: 6px;
                margin-top: 8px;
            }
            
            .image-preview-item {
                width: 70px;
                height: 70px;
            }
            
            .remove-image {
                width: 18px;
                height: 18px;
                font-size: 0.7em;
            }
            
            .mobile-nav button {
                min-width: 70px;
                padding: 8px 10px;
                font-size: 0.8em;
            }
            
            .report-container {
                margin: 0;
                padding: 10px;
                width: 100%;
                box-shadow: none;
            }
            
            .report-header h2 {
                font-size: 14px !important;
            }
            
            .person-table,
            .details-table {
                font-size: 9px;
            }
            
            /* Unterschriften f√ºr mobile - vertikal */
            .signature-area {
                flex-direction: column !important;
                gap: 15px !important;
            }
            
            .signature-box {
                width: 100% !important;
                margin-bottom: 15px !important;
            }
            
            /* Autoriserung mobile */
            .authorization-header h1 {
                font-size: 20px !important;
            }
            
            .authorization-signatures {
                flex-direction: column !important;
                gap: 20px !important;
            }
            
            .authorization-signature-field {
                width: 100% !important;
                margin-bottom: 20px !important;
            }
            
            /* Schlie√üen- und Druck-Buttons auf Mobile */
            .report-action-buttons {
                top: 5px;
                right: 5px;
                gap: 3px;
            }
            
            .report-action-btn {
                width: 25px;
                height: 25px;
                font-size: 14px;
            }
        }
        
        /* SEHR KLEINE DISPLAYS */
        @media (max-width: 360px) {
            .audit-status {
                font-size: 0.7em;
                padding: 6px;
            }
            
            .controls-row-1 button,
            .controls-row-2 button {
                padding: 4px 3px;
                font-size: 0.6em;
                height: 30px;
            }
            
            .audit-btn {
                padding: 8px 6px;
                min-height: 60px;
                font-size: 0.8em;
            }
            
            .question-text {
                font-size: 0.9em;
            }
            
            /* Optimierte Buttons f√ºr sehr kleine Displays */
            .verdict-btn {
                padding: 6px 4px;
                font-size: 0.8em;
                min-height: 36px;
            }
            
            .verdict-btn span {
                font-size: 0.9em;
                margin-right: 3px;
            }
            
            /* Noch kompaktere Kommentarfelder */
            .comment {
                min-height: 45px !important;
                padding: 6px;
                font-size: 0.8em;
            }
            
            .image-preview-item {
                width: 60px;
                height: 60px;
            }
            
            .mobile-nav button {
                min-width: 60px;
                padding: 6px 8px;
                font-size: 0.75em;
            }
            
            /* Statusanzeige f√ºr sehr kleine Displays */
            .progress-bar {
                height: 8px;
            }
            /* === BILDER IM BERICHT === */
            .report-image-container {
                margin: 10px 0;
                padding: 8px;
                border: 1px solid #ddd;
                background: #f9f9f9;
            }

            .report-image-grid {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-top: 8px;
            }

            .report-image-item {
                border: 1px solid #ccc;
                padding: 5px;
                background: white;
                text-align: center;
            }

            .report-image {
                max-width: 80px;
                max-height: 80px;
                object-fit: contain;
                border: 1px solid #eee;
            }


            /* Beim Drucken */
            @media print {
                .report-image {
                    max-width: 70px;
                    max-height: 70px;
                }
            }

            /* F√ºr Dark Mode - Bilder bleiben immer sichtbar */
            @media (prefers-color-scheme: dark) {
                .report-container .report-image-container {
                    background: #f9f9f9 !important;
                }
                .report-container .report-image-item {
                    background: white !important;
                }
            }
    </style>
</head>
<body>
    <!-- CUSTOM MODAL -->
    <div id="customModal" class="custom-modal">
        <div class="custom-modal-content">
            <div id="modalMessage">M√∂chten Sie fortfahren?</div>
            <div class="custom-modal-buttons">
                <button id="modalCancelBtn" class="custom-modal-btn cancel">Nein</button>
                <button id="modalConfirmBtn" class="custom-modal-btn confirm">Ja</button>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>ZfP Operator Audit</h1>
            <div class="subtitle">Zerst√∂rungsfreie Pr√ºfverfahren - Operator Qualifizierung</div>
        </header>

        <!-- AUDIT AUSWAHL -->
        <div id="auditSelection" class="audit-selection active">
            <h2>Pr√ºfverfahren ausw√§hlen:</h2>
            <div class="audit-buttons">
                <button class="audit-btn wirbelstrom" data-audit="wirbelstrom">
                    <div class="btn-icon">‚ö°</div>
                    <span>Wirbelstrompr√ºfung</span>
                    <div class="btn-progress" id="wirbelstromProgress">0%</div>
                </button>
                <button class="audit-btn magnetpulver" data-audit="magnetpulver">
                    <div class="btn-icon">üß≤</div>
                    <span>Magnetpulverpr√ºfung</span>
                    <div class="btn-progress" id="magnetpulverProgress">0%</div>
                </button>
                <button class="audit-btn nital" data-audit="nital">
                    <div class="btn-icon">üß™</div>
                    <span>Nital-√Ñtzen</span>
                    <div class="btn-progress" id="nitalProgress">0%</div>
                </button>
                <button class="audit-btn ultraschall" data-audit="ultraschall">
                    <div class="btn-icon">üì°</div>
                    <span>Ultraschallpr√ºfung</span>
                    <div class="btn-progress" id="ultraschallProgress">0%</div>
                </button>
            </div>
        </div>

        <!-- AUDIT CONTENT -->
        <div id="auditContent" class="audit-content">
            <!-- CONTROLS -->
            <div class="controls-row-1">
                <button class="btn-back" id="backBtn">‚Üê Zur√ºck</button>
                <button class="btn-export" id="exportBtn">üìÅ Export JSON</button>
                <button class="btn-audit-load" id="auditLoadBtn">üìÇ Audit Laden</button>
                <button class="btn-authorization" id="authorizationBtn">üìã Autorisierung</button>
            </div>

            <div class="controls-row-2">
                <button class="btn-report" id="reportBtn">üìä Auditbericht</button>
                <button class="btn-desktop" id="toggleViewBtn">üì± Mobile</button>
                <button class="btn-danger" id="resetBtn">üóëÔ∏è Reset Audit</button>
                <button class="btn-success" id="uploadQuestionsBtn">üìÑ Fragenkatalog</button>
            </div>

            <!-- KOPFDATEN DESKTOP -->
            <div class="header-section desktop-view" id="desktopHeaderSection">
                <h3>
                    <span>üìÑ Audit-Kopfdaten</span>
                    <button class="toggle-header-btn" id="desktopToggleHeader">Ausblenden</button>
                </h3>
                <div class="header-content" id="desktopHeaderContent">
                    <div class="header-grid">
                        <div class="header-group">
                            <h4>Operator</h4>
                            <input type="text" class="header-input" id="operatorName" placeholder="Name">
                            <input type="text" class="header-input" id="operatorNumber" placeholder="Mitarbeiter-Nr.">
                            <input type="text" class="header-input" id="operatorCert" placeholder="Zertifikat">
                            <input type="text" class="header-input" id="operatorDept" placeholder="Abteilung">
                        </div>
                        <div class="header-group">
                            <h4>Auditor (Level II)</h4>
                            <input type="text" class="header-input" id="auditorName" placeholder="Name">
                            <input type="text" class="header-input" id="auditorDept" placeholder="Abteilung">
                            <input type="text" class="header-input" id="auditorCert" placeholder="Zertifikat">
                            <input type="text" class="header-input" id="auditorPhone" placeholder="Telefon">
                        </div>
                        <div class="header-group">
                            <h4>Supervisor (Level III)</h4>
                            <input type="text" class="header-input" id="approverName" placeholder="Name">
                            <input type="text" class="header-input" id="approverDept" placeholder="Abteilung">
                            <input type="text" class="header-input" id="approverCert" placeholder="Zertifikat">
                            <input type="text" class="header-input" id="approverPhone" placeholder="Telefon">
                        </div>
                        <div class="header-group">
                            <h4>Pr√ºfungsdetails</h4>
                            <input type="text" class="header-input" id="reportNumber" placeholder="Pr√ºfbericht-Nr.">
                            <input type="text" class="header-input" id="partType" placeholder="Teiletype">
                            <input type="text" class="header-input" id="externalStandard" placeholder="Externe Norm">
                            <input type="text" class="header-input" id="sStandard" placeholder="S-Standard">
                            <input type="text" class="header-input" id="workInstruction" placeholder="Lokale Instruktion">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Kopfdaten -->
            <div class="header-section mobile-view mobile-header-section collapsed" id="mobileHeaderSection">
                <h3>
                    <span>üìÑ Audit-Daten</span>
                    <button class="toggle-header-btn" id="mobileToggleHeader">Einblenden</button>
                </h3>
                <div class="header-content" id="mobileHeaderContent">
                    <div class="header-grid">
                        <div class="header-group">
                            <h4>Operator</h4>
                            <input type="text" class="header-input" id="mobileOperatorName" placeholder="Name">
                            <input type="text" class="header-input" id="mobileOperatorNumber" placeholder="Mitarbeiter-Nr.">
                            <input type="text" class="header-input" id="mobileOperatorCert" placeholder="Zertifikat">
                            <input type="text" class="header-input" id="mobileOperatorDept" placeholder="Abteilung">
                        </div>
                        <div class="header-group">
                            <h4>Auditor (Level II)</h4>
                            <input type="text" class="header-input" id="mobileAuditorName" placeholder="Name">
                            <input type="text" class="header-input" id="mobileAuditorDept" placeholder="Abteilung">
                            <input type="text" class="header-input" id="mobileAuditorCert" placeholder="Zertifikat">
                            <input type="text" class="header-input" id="mobileAuditorPhone" placeholder="Telefon">
                        </div>
                        <div class="header-group">
                            <h4>Freigeber (Level III)</h4>
                            <input type="text" class="header-input" id="mobileApproverName" placeholder="Name">
                            <input type="text" class="header-input" id="mobileApproverDept" placeholder="Abteilung">
                            <input type="text" class="header-input" id="mobileApproverCert" placeholder="Zertifikat">
                            <input type="text" class="header-input" id="mobileApproverPhone" placeholder="Telefon">
                        </div>
                        <div class="header-group">
                            <h4>Pr√ºfungsdetails</h4>
                            <input type="text" class="header-input" id="mobileReportNumber" placeholder="Pr√ºfbericht-Nr.">
                            <input type="text" class="header-input" id="mobilePartType" placeholder="Teiletype">
                            <input type="text" class="header-input" id="mobileExternalStandard" placeholder="Externe Norm">
                            <input type="text" class="header-input" id="mobileSStandard" placeholder="S-Standard">
                            <input type="text" class="header-input" id="mobileWorkInstruction" placeholder="Lokale Instruktion">
                        </div>
                    </div>
                </div>
            </div>

            <!-- STATUSLEISTE -->
            <div class="audit-status">
                <div class="status-header">
                    <div class="status-text">
                        Status: <strong id="auditStatusText">In Bearbeitung</strong>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                            <div class="progress-text" id="progressText">0%</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Gesamtergebnis -->
            <div id="finalResult" class="final-result">
                <div id="resultIcon" style="font-size: 1.2em; margin-bottom: 5px;"></div>
                <div id="resultText" style="font-size: 0.9em;"></div>
            </div>

            <!-- Desktop Ansicht -->
            <div class="desktop-view" id="desktopView">
                <div id="auditSections"></div>
            </div>

            <!-- Mobile Ansicht -->
            <div class="mobile-view" id="mobileView">
                <div class="mobile-section-selector" id="sectionSelector"></div>
                <div id="mobileQuestions"></div>
                <div class="mobile-nav">
                    <button class="btn-secondary" id="prevBtn">‚Üê Zur√ºck</button>
                    <span id="mobileCounter">1/1</span>
                    <button class="btn-secondary" id="nextBtn">Weiter ‚Üí</button>
                </div>
            </div>
        </div>

        <footer>
            <p>Operator Audit Tool - Schaeffler Technologies AG & Co. KG</p>
            <div class="version-info">Version AA - 10.01.2026</div>
            <div class="creator-info">Ersteller: H√§usner Daniel, WI/SW2-PQT</div>
        </footer>
    </div>

    <!-- BERICHTS OVERLAY -->
    <div id="reportOverlay" class="report-overlay">
        <div class="report-container" id="reportContainer">
            <!-- Aktions-Buttons -->
            <div class="report-action-buttons">
                <button class="report-action-btn print-btn" onclick="printFullReport()">üñ®Ô∏è</button>
                <button class="report-action-btn close-btn" onclick="closeReport()">‚úï</button>
            </div>
            <!-- Bericht wird hier dynamisch eingef√ºgt -->
        </div>
    </div>

    <!-- AUTORISIERUNGS OVERLAY -->
    <div id="authorizationOverlay" class="report-overlay">
        <div class="report-container" id="authorizationContainer">
            <!-- Aktions-Buttons -->
            <div class="report-action-buttons">
                <button class="report-action-btn print-btn" onclick="printFullAuthorization()">üñ®Ô∏è</button>
                <button class="report-action-btn close-btn" onclick="closeAuthorization()">‚úï</button>
            </div>
            <!-- Autorisierung wird hier dynamisch eingef√ºgt -->
        </div>
    </div>

    <!-- VERSTECKTE INPUTS -->
    <input type="file" id="fileLoader" accept=".json" style="display: none;">
    <input type="file" id="questionsLoader" accept=".json" style="display: none;">

    <script>
        // === KONSTANTEN ===
        const AUDIT_TYPES = {
            wirbelstrom: { 
                id: 'wirbelstrom', 
                title: 'Wirbelstrompr√ºfung', 
                short: 'ET', 
                color: '#3498db', 
                icon: '‚ö°',
                norm: '',
                instruction: ''
            },
            magnetpulver: { 
                id: 'magnetpulver', 
                title: 'Magnetpulverpr√ºfung', 
                short: 'MT', 
                color: '#e74c3c', 
                icon: 'üß≤',
                norm: '',
                instruction: ''
            },
            nital: { 
                id: 'nital', 
                title: 'Nital-√Ñtzen', 
                short: 'NE', 
                color: '#2ecc71', 
                icon: 'üß™',
                norm: '',
                instruction: ''
            },
            ultraschall: { 
                id: 'ultraschall', 
                title: 'Ultraschallpr√ºfung', 
                short: 'UT', 
                color: '#9b59b6', 
                icon: 'üì°',
                norm: '',
                instruction: ''
            }
        };

        // FRAGENSTRUKTUR
        const STANDARD_QUESTIONS = {
            wirbelstrom: [
                {
                    title: "1. Qualifikation & Dokumentation",
                    short: "Qualifikation",
                    questions: [
                        { 
                            id: "ET-1.1", 
                            text: "Sehtest g√ºltig (‚â§12 Monate) und Zertifikat vorgelegt",
                            english: "Eye test valid (‚â§12 months) and certificate presented"
                        },
                        { 
                            id: "ET-1.2", 
                            text: "ET Level 2 Zertifikat ISO/ASNT-konform vorhanden",
                            english: "ET Level 2 certificate ISO/ASNT compliant available"
                        },
                        { 
                            id: "ET-1.3", 
                            text: "Kenntnis der Norm S285066 und Arbeitsanweisung INFSW_17005 nachgewiesen",
                            english: "Knowledge of standard S285066 and work instruction INFSW_17005 demonstrated"
                        }
                    ]
                },
                {
                    title: "2. Ger√§teeinrichtung & Kalibrierung",
                    short: "Ger√§tepr√ºfung",
                    questions: [
                        { 
                            id: "ET-2.1", 
                            text: "T√§gliche Plausibilit√§tspr√ºfung korrekt durchgef√ºhrt und dokumentiert",
                            english: "Daily plausibility check correctly performed and documented"
                        },
                        { 
                            id: "ET-2.2", 
                            text: "Referenzteile gem√§√ü Norm vorhanden und korrekt gelagert",
                            english: "Reference parts according to standard available and correctly stored"
                        },
                        { 
                            id: "ET-2.3", 
                            text: "Ger√§teparameter entsprechend Pr√ºfanweisung eingestellt",
                            english: "Device parameters set according to inspection instruction"
                        }
                    ]
                },
                {
                    title: "3. Pr√ºfdurchf√ºhrung & Bewertung",
                    short: "Pr√ºfung",
                    questions: [
                        { 
                            id: "ET-3.1", 
                            text: "Systematische Pr√ºfung aller definierten Bereiche",
                            english: "Systematic inspection of all defined areas"
                        },
                        { 
                            id: "ET-3.2", 
                            text: "Korrekte Erkennung und Bewertung von Fehleranzeigen",
                            english: "Correct detection and evaluation of defect indications"
                        },
                        { 
                            id: "ET-3.3", 
                            text: "n.i.O.-Teile korrekt erkannt und als 'nicht i.O.' deklariert",
                            english: "Rejected parts correctly identified and declared as 'not OK'"
                        },
                        { 
                            id: "ET-3.4", 
                            text: "Keine Fehlbewertungen (gute Teile als n.i.O. deklariert)",
                            english: "No false rejections (good parts declared as not OK)"
                        }
                    ]
                },
                {
                    title: "4. Dokumentation & Qualit√§tssicherung",
                    short: "Dokumentation",
                    questions: [
                        { 
                            id: "ET-4.1", 
                            text: "Vollst√§ndige und lesbare Dokumentation aller Pr√ºfergebnisse",
                            english: "Complete and legible documentation of all test results"
                        },
                        { 
                            id: "ET-4.2", 
                            text: "Korrekte Anwendung des Zwischenbeh√§lter-Prinzips (Trennung i.O./n.i.O.)",
                            english: "Correct application of intermediate container principle (separation OK/not OK)"
                        },
                        { 
                            id: "ET-4.3", 
                            text: "Entmagnetisierung bei Bedarf durchgef√ºhrt und Grenzwerte kontrolliert",
                            english: "Demagnetization performed when required and limit values controlled"
                        },
                        { 
                            id: "ET-4.4", 
                            text: "T√§tigkeitsnachweis vorhanden und vollst√§ndig dokumentiert",
                            english: "Activity proof available and fully documented",
                            isActivityProof: true
                        }
                    ]
                }
            ],
            magnetpulver: [
                {
                    title: "1. Qualifikation & Normenkenntnis",
                    short: "Qualifikation",
                    questions: [
                        { 
                            id: "MT-1.1", 
                            text: "Sehtest g√ºltig (‚â§12 Monate) und dokumentiert",
                            english: "Eye test valid (‚â§12 months) and documented"
                        },
                        { 
                            id: "MT-1.2", 
                            text: "MT Level 2 Zertifikat ISO/IASNT-konform vorhanden",
                            english: "MT Level 2 certificate ISO/IASNT compliant available"
                        },
                        { 
                            id: "MT-1.3", 
                            text: "Kenntnis Normen (DIN EN ISO 9934, S24000-8) und Arbeitsanweisung INFSW01044",
                            english: "Knowledge of standards (DIN EN ISO 9934, S24000-8) and work instruction INFSW01044"
                        }
                    ]
                },
                {
                    title: "2. Ger√§tepr√ºfung & Kalibrierung",
                    short: "Ger√§tepr√ºfung",
                    questions: [
                        { 
                            id: "MT-2.1", 
                            text: "UV-Lampe √ºberpr√ºft (Intensit√§t, Filter) und dokumentiert",
                            english: "UV lamp checked (intensity, filter) and documented"
                        },
                        { 
                            id: "MT-2.2", 
                            text: "UV- und Belichtungsmesser gem√§√ü Vorgabe kalibriert",
                            english: "UV and lux meter calibrated according to specification"
                        },
                        { 
                            id: "MT-2.3", 
                            text: "Magnetisierung f√ºr alle Ausrichtungen gepr√ºft, Grenzwerte eingehalten",
                            english: "Magnetization checked for all orientations, limit values maintained"
                        },
                        { 
                            id: "MT-2.4", 
                            text: "MTU-Pr√ºfk√∂rper 3 Kontrolle durchgef√ºhrt",
                            english: "MTU test body 3 control performed"
                        }
                    ]
                },
                {
                    title: "3. Pr√ºfdurchf√ºhrung & Fehlererkennung",
                    short: "Pr√ºfung",
                    questions: [
                        { 
                            id: "MT-3.1", 
                            text: "Vollst√§ndige Inspektion aller relevanten Oberfl√§chen",
                            english: "Complete inspection of all relevant surfaces"
                        },
                        { 
                            id: "MT-3.2", 
                            text: "Korrekte Interpretation von Rissanzeigen",
                            english: "Correct interpretation of crack indications"
                        },
                        { 
                            id: "MT-3.3", 
                            text: "n.i.O.-Teile korrekt erkannt und als 'nicht i.O.' deklariert",
                            english: "Rejected parts correctly identified and declared as 'not OK'"
                        },
                        { 
                            id: "MT-3.4", 
                            text: "Keine Fehlbewertungen (falsche Interpretationen)",
                            english: "No mis-evaluations (false interpretations)"
                        }
                    ]
                },
                {
                    title: "4. Dokumentation & Qualit√§tssicherung",
                    short: "Dokumentation",
                    questions: [
                        { 
                            id: "MT-4.1", 
                            text: "Korrekte Verwendung der Dokumentationsvorlage",
                            english: "Correct use of documentation template"
                        },
                        { 
                            id: "MT-4.2", 
                            text: "Lesbare Dokumentation aller Indikationen und Ma√ünahmen",
                            english: "Legible documentation of all indications and measures"
                        },
                        { 
                            id: "MT-4.3", 
                            text: "Entmagnetisierung korrekt durchgef√ºhrt und dokumentiert",
                            english: "Demagnetization correctly performed and documented"
                        },
                        { 
                            id: "MT-4.4", 
                            text: "T√§tigkeitsnachweis vorhanden und vollst√§ndig dokumentiert",
                            english: "Activity proof available and fully documented",
                            isActivityProof: true
                        }
                    ]
                }
            ],
            ultraschall: [
                {
                    title: "1. Qualifikation & Normenkenntnis",
                    short: "Qualifikation",
                    questions: [
                        { 
                            id: "UT-1.1", 
                            text: "Sehtest g√ºltig (‚â§12 Monate) und dokumentiert",
                            english: "Eye test valid (‚â§12 months) and documented"
                        },
                        { 
                            id: "UT-1.2", 
                            text: "UT Level 2 Zertifikat ISO/ASNT-konform vorhanden",
                            english: "UT Level 2 certificate ISO/ASNT compliant available"
                        },
                        { 
                            id: "UT-1.3", 
                            text: "Kenntnis Normen (DIN EN ISO 22232, S231202-5) und Arbeitsanweisungen",
                            english: "Knowledge of standards (DIN EN ISO 22232, S231202-5) and work instructions"
                        }
                    ]
                },
                {
                    title: "2. Kalibrierung & Ger√§teeinstellung",
                    short: "Kalibrierung",
                    questions: [
                        { 
                            id: "UT-2.1", 
                            text: "Sensitivit√§tskalibrierung gem√§√ü Norm durchgef√ºhrt",
                            english: "Sensitivity calibration performed according to standard"
                        },
                        { 
                            id: "UT-2.2", 
                            text: "Distanzkalibrierung gem√§√ü Norm durchgef√ºhrt",
                            english: "Distance calibration performed according to standard"
                        },
                        { 
                            id: "UT-2.3", 
                            text: "Ger√§teeinrichtung korrekt demonstriert",
                            english: "Device setup correctly demonstrated"
                        }
                    ]
                },
                {
                    title: "3. Pr√ºfdurchf√ºhrung & Defekterkennung",
                    short: "Pr√ºfung",
                    questions: [
                        { 
                            id: "UT-3.1", 
                            text: "Systematische Pr√ºfung aller vorgegebenen Bereiche",
                            english: "Systematic inspection of all specified areas"
                        },
                        { 
                            id: "UT-3.2", 
                            text: "Korrekte R√ºckkehr zum gr√∂√üten Defekt f√ºr Messung",
                            english: "Correct return to largest defect for measurement"
                        },
                        { 
                            id: "UT-3.3", 
                            text: "Genauigkeit der Tiefenmessung und Dimensionierung",
                            english: "Accuracy of depth measurement and dimensioning"
                        },
                        { 
                            id: "UT-3.4", 
                            text: "n.i.O.-Teile korrekt erkannt und als 'nicht i.O.' deklariert",
                            english: "Rejected parts correctly identified and declared as 'not OK'"
                        }
                    ]
                },
                {
                    title: "4. Dokumentation & Qualit√§tssicherung",
                    short: "Dokumentation",
                    questions: [
                        { 
                            id: "UT-4.1", 
                            text: "Dokumentation gem√§√ü Arbeitsanweisung korrekt durchgef√ºhrt",
                            english: "Documentation according to work instruction correctly performed"
                        },
                        { 
                            id: "UT-4.2", 
                            text: "Vollst√§ndige Aufzeichnung aller Pr√ºfergebnisse",
                            english: "Complete recording of all test results"
                        },
                        { 
                            id: "UT-4.3", 
                            text: "Klare Kennzeichnung und Trennung von n.i.O.-Teilen",
                            english: "Clear marking and separation of rejected parts"
                        },
                        { 
                            id: "UT-4.4", 
                            text: "T√§tigkeitsnachweis vorhanden und vollst√§ndig dokumentiert",
                            english: "Activity proof available and fully documented",
                            isActivityProof: true
                        }
                    ]
                }
            ],
            nital: [
                {
                    title: "1. Qualifikation & Sicherheit",
                    short: "Qualifikation",
                    questions: [
                        { 
                            id: "NE-1.1", 
                            text: "Sehtest g√ºltig (‚â§12 Monate) und dokumentiert",
                            english: "Eye test valid (‚â§12 months) and documented"
                        },
                        { 
                            id: "NE-1.2", 
                            text: "NE Level 2 Zertifikat vorhanden",
                            english: "NE Level 2 certificate available"
                        },
                        { 
                            id: "NE-1.3", 
                            text: "Sicherheitsunterweisung f√ºr S√§urehandhabung nachgewiesen",
                            english: "Safety training for acid handling demonstrated"
                        }
                    ]
                },
                {
                    title: "2. Prozesskontrolle & Chemikalien",
                    short: "Prozesskontrolle",
                    questions: [
                        { 
                            id: "NE-2.1", 
                            text: "Reinigungsprozess entspricht Norm (Parameter, Ultraschall)",
                            english: "Cleaning process complies with standard (parameters, ultrasonic)"
                        },
                        { 
                            id: "NE-2.2", 
                            text: "√Ñtzmittel korrekt gelagert und √ºberwacht (chemische Analyse)",
                            english: "Etching agent correctly stored and monitored (chemical analysis)"
                        },
                        { 
                            id: "NE-2.3", 
                            text: "√Ñtzparameter entsprechend Arbeitsanweisung eingehalten",
                            english: "Etching parameters maintained according to work instruction"
                        }
                    ]
                },
                {
                    title: "3. Pr√ºfung & Bewertung",
                    short: "Pr√ºfung",
                    questions: [
                        { 
                            id: "NE-3.1", 
                            text: "Systematische Inspektion der ge√§tzten Fl√§chen",
                            english: "Systematic inspection of etched surfaces"
                        },
                        { 
                            id: "NE-3.2", 
                            text: "Korrekte Bewertung von Gef√ºgestrukturen und Anomalien",
                            english: "Correct evaluation of microstructure and anomalies"
                        },
                        { 
                            id: "NE-3.3", 
                            text: "n.i.O.-Teile korrekt erkannt und als 'nicht i.O.' deklariert",
                            english: "Rejected parts correctly identified and declared as 'not OK'"
                        },
                        { 
                            id: "NE-3.4", 
                            text: "Unterscheidung zwischen relevanten und nicht relevanten Anzeigen",
                            english: "Differentiation between relevant and non-relevant indications"
                        }
                    ]
                },
                {
                    title: "4. Dokumentation & Nachverfolgbarkeit",
                    short: "Dokumentation",
                    questions: [
                        { 
                            id: "NE-4.1", 
                            text: "Vollst√§ndige Dokumentation aller Prozessparameter",
                            english: "Complete documentation of all process parameters"
                        },
                        { 
                            id: "NE-4.2", 
                            text: "Nachweis der korrekten √Ñtzung (Bilder/Dokumentation)",
                            english: "Proof of correct etching (pictures/documentation)"
                        },
                        { 
                            id: "NE-4.3", 
                            text: "Trennung von i.O. und n.i.O. Teilen gew√§hrleistet",
                            english: "Separation of OK and not OK parts ensured"
                        },
                        { 
                            id: "NE-4.4", 
                            text: "T√§tigkeitsnachweis vorhanden und vollst√§ndig dokumentiert",
                            english: "Activity proof available and fully documented",
                            isActivityProof: true
                        }
                    ]
                }
            ]
        };

        // === GLOBALE VARIABLEN ===
        let currentAuditType = null;
        let currentAuditData = null;
        let allQuestions = [];
        let currentMobileQuestion = 0;
        let imageStorage = {};
        let uploadedImages = new Set();
        let customModalResolve = null;

        function printFullReport() {
            const reportContainer = document.getElementById('reportContainer');
            const printContent = reportContainer.innerHTML;
            
            // Entferne nur die Action-Buttons
            const cleanContent = printContent.replace(
                /<div class="report-action-buttons">[\s\S]*?<\/div>/, 
                ''
            );
            
            // Pr√ºfe ob mobile Version
            const isMobile = window.innerWidth <= 768;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>ZfP Audit Bericht - Schaeffler</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        html, body {
                            height: 100%;
                            margin: 0;
                            padding: 0;
                        }
                        body { 
                            font-family: Arial, sans-serif; 
                            padding: 15px; 
                            color: #000;
                            font-size: 10pt;
                            line-height: 1.3;
                            ${isMobile ? 'transform: scale(0.93); transform-origin: top left;' : ''}
                            /* WICHTIG: Keine width-Anpassung, nur transform */
                        }
                        @page { 
                            size: A4 portrait; 
                            margin: 15mm; 
                        }
                        .report-header {
                            border-bottom: 2px solid #000;
                            padding-bottom: 8px;
                            margin-bottom: 12px;
                            text-align: center;
                        }
                        .report-header h2 {
                            font-size: 14pt;
                            margin: 0 0 4px 0;
                            color: #000;
                        }
                        .company-info {
                            font-size: 9pt;
                            margin: 2px 0;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 8px 0;
                            font-size: 9pt;
                        }
                        th, td {
                            border: 1px solid #000;
                            padding: 5px;
                            vertical-align: top;
                        }
                        th {
                            background: #f0f0f0;
                            font-weight: bold;
                        }
                        .details-table td:first-child {
                            font-weight: bold;
                            width: 25%;
                            background: #f9f9f9;
                        }
                        .results-section {
                            margin: 15px 0;
                        }
                        .report-section-header {
                            font-size: 10pt;
                            font-weight: bold;
                            margin: 12px 0 6px 0;
                            padding-bottom: 2px;
                            border-bottom: 1px solid #000;
                        }
                        .question-item {
                            margin: 3px 0;
                            padding: 4px;
                            font-size: 9pt;
                            line-height: 1.2;
                        }
                        .question-item.ok {
                            border-left: 2px solid #00a000;
                            background: #f0fff0;
                        }
                        .question-item.not-ok {
                            border-left: 2px solid #ff0000;
                            background: #fff0f0;
                        }
                        .question-id {
                            font-weight: bold;
                        }
                        .question-comment {
                            font-style: italic;
                            color: #666;
                            margin-left: 8px;
                            font-size: 8pt;
                        }
                        .signature-area {
                            margin-top: 30px;
                            padding-top: 15px;
                            border-top: 1px solid #000;
                            display: flex;
                            justify-content: space-between;
                            gap: 20px;
                        }
                        .signature-box {
                            flex: 1;
                            text-align: center;
                        }
                        /* WICHTIG: KEINE LINIEN IN DEN UNTERSCHRIFTSFELDERN */
                        .signature-line {
                            /* KEINE BORDER - NUR ABSTAND */
                            margin-top: 50px;
                            min-height: 40px;
                        }
                        /* FOOTER */
                        body > div:last-child {
                            margin-top: 15px;
                            padding-top: 8px;
                            border-top: 1px solid #ccc;
                            font-size: 9pt;
                        }
                        body > div:last-child table {
                            width: 100%;
                            border: none;
                        }
                        body > div:last-child table td {
                            border: none;
                            padding: 0;
                            vertical-align: top;
                        }
                        @media print {
                            html, body {
                                height: auto;
                            }
                            body { 
                                padding: 0; 
                                ${isMobile ? 'transform: scale(0.93) !important; transform-origin: top left !important;' : ''}
                                /* KEINE width-Anpassung im Druck! */
                            }
                            .signature-area { 
                                page-break-inside: avoid;
                                margin-top: 30px;
                            }
                            /* WICHTIG: KEINE LINIEN IN DEN UNTERSCHRIFTSFELDERN IM DRUCK */
                            .signature-line {
                                border-top: none !important;
                                border: none !important;
                                margin-top: 40px;
                                min-height: 40px;
                            }
                            table { font-size: 8pt; }
                            .question-item { font-size: 8pt; }
                            /* FOOTER IM DRUCK */
                            body > div:last-child {
                                margin-top: 10px;
                                padding-top: 5px;
                                font-size: 8pt;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${cleanContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Kurz warten, dann drucken
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 250);
        }
            
        function printFullAuthorization() {
            const authorizationContainer = document.getElementById('authorizationContainer');
            const printContent = authorizationContainer.innerHTML;
            
            // Entferne die Action-Buttons
            const cleanContent = printContent.replace(
                /<div class="report-action-buttons">[\s\S]*?<\/div>/, 
                ''
            );
            
            // Pr√ºfe ob mobile Version
            const isMobile = window.innerWidth <= 768;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Autorisierung ZfP - Schaeffler</title>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <style>
                        html, body {
                            height: 100%;
                            margin: 0;
                            padding: 0;
                        }
                        body { 
                            font-family: Arial, sans-serif; 
                            padding: 15px; 
                            color: #000;
                            font-size: 10pt;
                            line-height: 1.3;
                            ${isMobile ? 'transform: scale(0.93); transform-origin: top left;' : ''}
                        }
                        @page { 
                            size: A4 portrait; 
                            margin: 15mm; 
                        }
                        .authorization-header {
                            text-align: center;
                            border-bottom: 2px solid #000;
                            padding-bottom: 12px;
                            margin-bottom: 20px;
                        }
                        .authorization-header h1 {
                            font-size: 18pt;
                            margin: 0 0 8px 0;
                            color: #000;
                        }
                        .authorization-info {
                            margin: 15px 0;
                            padding: 12px;
                            border: 1px solid #ccc;
                            background: #f9f9f9;
                        }
                        .authorization-info p {
                            margin: 6px 0;
                            font-size: 10pt;
                        }
                        .authorization-text-box {
                            border: 2px solid #000;
                            padding: 15px;
                            margin: 20px 0;
                            font-size: 10pt;
                            line-height: 1.4;
                            background: #f9f9f9;
                            min-height: 100px;
                        }
                        .authorization-details {
                            margin: 20px 0;
                            padding: 12px;
                            border: 1px solid #ccc;
                            background: #fff;
                        }
                        .authorization-details p {
                            margin: 6px 0;
                            font-size: 9pt;
                        }
                        .authorization-signatures {
                            margin-top: 40px;
                            padding-top: 20px;
                            border-top: 2px solid #000;
                            display: flex;
                            justify-content: space-between;
                            gap: 30px;
                        }
                        .authorization-signature-field {
                            flex: 1;
                            text-align: center;
                        }
                        .authorization-signature-line {
                            margin-top: 40px;
                            padding-top: 8px;
                            min-height: 40px;
                        }
                        .authorization-stamp-box {
                            text-align: center;
                            margin: 1px auto;
                            padding: 12px;
                            border: 2px solid #000;
                            border-radius: 8px;
                            background: #fff;
                            width: 70%;
                            max-width: 250px;
                        }
                        .authorization-stamp-box div:first-child {
                            font-size: 12pt;
                            font-weight: bold;
                            margin-bottom: 20px;
                        }
                        /* FOOTER */
                        body > div:last-child {
                            margin-top: 30px;
                            padding-top: 10px;
                            border-top: 1px solid #ccc;
                            font-size: 9pt;
                        }
                        body > div:last-child table {
                            width: 100%;
                            border: none;
                        }
                        body > div:last-child table td {
                            border: none;
                            padding: 0;
                        }
                        @media print {
                            html, body {
                                height: auto;
                            }
                            body { 
                                padding: 0; 
                                ${isMobile ? 'transform: scale(0.93) !important; transform-origin: top left !important;' : ''}
                            }
                            .authorization-signatures { 
                                page-break-inside: avoid;
                                margin-top: 50px;
                            }
                            /* FOOTER IM DRUCK */
                            body > div:last-child {
                                margin-top: 20px;
                                padding-top: 8px;
                                font-size: 8pt;
                            }
                        }
                    </style>
                </head>
                <body>
                    ${cleanContent}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Kurz warten, dann drucken
            setTimeout(() => {
                printWindow.focus();
                printWindow.print();
            }, 250);
        }
            

        // === MODAL FUNKTIONEN ===
        function showCustomModal(message) {
            return new Promise((resolve) => {
                document.getElementById('modalMessage').textContent = message;
                document.getElementById('customModal').style.display = 'flex';
                customModalResolve = resolve;
            });
        }

        function closeCustomModal() {
            document.getElementById('customModal').style.display = 'none';
            customModalResolve = null;
        }

        // === INITIALISIERUNG ===
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
        });

        function initializeApp() {
            loadAllAuditData();
            updateAuditProgressDisplays();
            
            // Modal Event Listener
            document.getElementById('modalConfirmBtn').addEventListener('click', function() {
                if (customModalResolve) customModalResolve(true);
                closeCustomModal();
            });
            
            document.getElementById('modalCancelBtn').addEventListener('click', function() {
                if (customModalResolve) customModalResolve(false);
                closeCustomModal();
            });
            
            // Header Toggle Buttons
            document.getElementById('desktopToggleHeader').addEventListener('click', toggleDesktopHeader);
            document.getElementById('mobileToggleHeader').addEventListener('click', toggleMobileHeader);
            
            // Sync Header Daten
            syncHeaderData();
        }

        function setupEventListeners() {
            // Audit-Auswahl
            document.querySelectorAll('.audit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.classList.contains('disabled')) return;
                    startAudit(this.dataset.audit);
                });
            });

            // Controls
            document.getElementById('backBtn').addEventListener('click', goBackToSelection);
            document.getElementById('exportBtn').addEventListener('click', exportAudit);
            document.getElementById('auditLoadBtn').addEventListener('click', loadAudit);
            document.getElementById('authorizationBtn').addEventListener('click', showAuthorization);
            document.getElementById('reportBtn').addEventListener('click', showReport);
            document.getElementById('toggleViewBtn').addEventListener('click', toggleView);
            document.getElementById('resetBtn').addEventListener('click', resetAudit);
            document.getElementById('uploadQuestionsBtn').addEventListener('click', () => document.getElementById('questionsLoader').click());

            // File Loader
            document.getElementById('fileLoader').addEventListener('change', loadAuditData);
            document.getElementById('questionsLoader').addEventListener('change', loadQuestionsData);

            // Mobile Navigation
            document.getElementById('prevBtn').addEventListener('click', function() {
                if (currentMobileQuestion > 0) {
                    currentMobileQuestion--;
                    renderMobileQuestion();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });

            document.getElementById('nextBtn').addEventListener('click', function() {
                if (currentMobileQuestion < allQuestions.length - 1) {
                    currentMobileQuestion++;
                    renderMobileQuestion();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });

            // Responsive
            window.addEventListener('resize', handleResize);
            
            // Global Event Listener
            setupGlobalEventListeners();
        }

        function setupGlobalEventListeners() {
            // Section Header Klicks (Desktop)
            document.addEventListener('click', function(e) {
                if (e.target.closest('.section-header') && 
                    document.getElementById('desktopView').style.display === 'block') {
                    const header = e.target.closest('.section-header');
                    const section = header.closest('.section');
                    
                    section.classList.toggle('expanded');
                    
                    const arrow = header.querySelector('span');
                    if (section.classList.contains('expanded')) {
                        arrow.style.transform = 'rotate(90deg)';
                    } else {
                        arrow.style.transform = 'rotate(0deg)';
                    }
                    
                    e.preventDefault();
                    e.stopPropagation();
                }
            });
            
            // Verdict Buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.verdict-btn')) {
                    const btn = e.target.closest('.verdict-btn');
                    const questionElement = btn.closest('.question');
                    if (!questionElement) return;
                    
                    const questionId = questionElement.dataset.id;
                    const verdict = btn.dataset.verdict;
                    
                    updateQuestionData(questionId, 'verdict', verdict);
                    
                    questionElement.classList.remove('ok', 'not-ok');
                    questionElement.classList.add(verdict === 'ok' ? 'ok' : 'not-ok');
                    
                    questionElement.querySelectorAll('.verdict-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    
                    checkAndShowFinalResult();
                }
                
                // Remove Image Buttons
                if (e.target.classList.contains('remove-image')) {
                    const questionId = e.target.dataset.question;
                    const imageIndex = parseInt(e.target.dataset.index);
                    const isMobile = window.innerWidth <= 768;
                    removeImage(questionId, imageIndex, isMobile);
                }
            });
            
            // Kommentare
            document.addEventListener('input', function(e) {
                if (e.target.classList.contains('comment')) {
                    const questionId = e.target.closest('.question').dataset.id;
                    updateQuestionData(questionId, 'comment', e.target.value);
                }
                
                // Header-Daten
                if (e.target.classList.contains('header-input')) {
                    saveCurrentAuditData();
                }
            });
            
            // Bild-Uploads
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('image-input')) {
                    const questionId = e.target.dataset.question;
                    const isMobile = window.innerWidth <= 768;
                    handleImageUpload(e, questionId, isMobile);
                }
            });
        }

        // === HEADER TOGGLE FUNKTIONEN ===
        function toggleDesktopHeader() {
            const content = document.getElementById('desktopHeaderContent');
            const btn = document.getElementById('desktopToggleHeader');
            
            content.classList.toggle('collapsed');
            
            if (content.classList.contains('collapsed')) {
                btn.textContent = 'Einblenden';
            } else {
                btn.textContent = 'Ausblenden';
            }
        }

        function toggleMobileHeader() {
            const section = document.getElementById('mobileHeaderSection');
            const content = document.getElementById('mobileHeaderContent');
            const btn = document.getElementById('mobileToggleHeader');
            
            section.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
            
            if (section.classList.contains('collapsed')) {
                btn.textContent = 'Einblenden';
                section.style.padding = '0';
            } else {
                btn.textContent = 'Ausblenden';
                section.style.padding = '';
            }
        }

        // === HEADER DATEN SYNC ===
        function syncHeaderData() {
            // Mobile zu Desktop sync
            const mobileIds = [
                'mobileOperatorName', 'mobileOperatorNumber', 'mobileOperatorCert', 'mobileOperatorDept',
                'mobileAuditorName', 'mobileAuditorDept', 'mobileAuditorCert', 'mobileAuditorPhone',
                'mobileApproverName', 'mobileApproverDept', 'mobileApproverCert', 'mobileApproverPhone',
                'mobileReportNumber', 'mobilePartType', 'mobileExternalStandard', 'mobileSStandard', 'mobileWorkInstruction'
            ];
            
            mobileIds.forEach(mobileId => {
                const mobileElement = document.getElementById(mobileId);
                if (mobileElement) {
                    mobileElement.addEventListener('input', function() {
                        const desktopId = mobileId.replace('mobile', '').charAt(0).toLowerCase() + mobileId.replace('mobile', '').slice(1);
                        const desktopElement = document.getElementById(desktopId);
                        if (desktopElement) {
                            desktopElement.value = this.value;
                        }
                        saveCurrentAuditData();
                    });
                }
            });
            
            // Desktop zu Mobile sync
            const desktopIds = [
                'operatorName', 'operatorNumber', 'operatorCert', 'operatorDept',
                'auditorName', 'auditorDept', 'auditorCert', 'auditorPhone',
                'approverName', 'approverDept', 'approverCert', 'approverPhone',
                'reportNumber', 'partType', 'externalStandard', 'sStandard', 'workInstruction'
            ];
            
            desktopIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', function() {
                        const mobileId = 'mobile' + id.charAt(0).toUpperCase() + id.slice(1);
                        const mobileElement = document.getElementById(mobileId);
                        if (mobileElement) {
                            mobileElement.value = this.value;
                        }
                        saveCurrentAuditData();
                    });
                }
            });
        }

        // === RESET HEADER-FELDER ===
        function resetAllHeaderFields() {
            const allIds = [
                'operatorName', 'operatorNumber', 'operatorCert', 'operatorDept',
                'auditorName', 'auditorDept', 'auditorCert', 'auditorPhone',
                'approverName', 'approverDept', 'approverCert', 'approverPhone',
                'reportNumber', 'partType', 'externalStandard', 'sStandard', 'workInstruction',
                'mobileOperatorName', 'mobileOperatorNumber', 'mobileOperatorCert', 'mobileOperatorDept',
                'mobileAuditorName', 'mobileAuditorDept', 'mobileAuditorCert', 'mobileAuditorPhone',
                'mobileApproverName', 'mobileApproverDept', 'mobileApproverCert', 'mobileApproverPhone',
                'mobileReportNumber', 'mobilePartType', 'mobileExternalStandard', 'mobileSStandard', 'mobileWorkInstruction'
            ];
            
            allIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = '';
                }
            });
        }

        // === AUDIT MANAGEMENT ===
        function loadAllAuditData() {
            Object.keys(AUDIT_TYPES).forEach(auditType => {
                const saved = localStorage.getItem(`zfpAudit_${auditType}`);
                if (!saved) {
                    const sections = STANDARD_QUESTIONS[auditType];
                    const allQuestionsForAudit = sections.flatMap(section => 
                        section.questions.map(q => ({
                            ...q,
                            sectionTitle: section.title,
                            sectionShort: section.short,
                            verdict: null,
                            comment: "",
                            images: []
                        }))
                    );
                    
                    const initialData = {
                        meta: {
                            created: new Date().toISOString(),
                            lastModified: new Date().toISOString(),
                            auditType: auditType,
                            title: AUDIT_TYPES[auditType].title,
                            version: "2.5"
                        },
                        headerData: {},
                        questions: allQuestionsForAudit,
                        images: {}
                    };
                    localStorage.setItem(`zfpAudit_${auditType}`, JSON.stringify(initialData));
                }
            });
        }

        function getHeaderData() {
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                return {
                    operatorName: document.getElementById('mobileOperatorName')?.value || '',
                    operatorNumber: document.getElementById('mobileOperatorNumber')?.value || '',
                    operatorCert: document.getElementById('mobileOperatorCert')?.value || '',
                    operatorDept: document.getElementById('mobileOperatorDept')?.value || '',
                    auditorName: document.getElementById('mobileAuditorName')?.value || '',
                    auditorDept: document.getElementById('mobileAuditorDept')?.value || '',
                    auditorCert: document.getElementById('mobileAuditorCert')?.value || '',
                    auditorPhone: document.getElementById('mobileAuditorPhone')?.value || '',
                    approverName: document.getElementById('mobileApproverName')?.value || '',
                    approverDept: document.getElementById('mobileApproverDept')?.value || '',
                    approverCert: document.getElementById('mobileApproverCert')?.value || '',
                    approverPhone: document.getElementById('mobileApproverPhone')?.value || '',
                    reportNumber: document.getElementById('mobileReportNumber')?.value || '',
                    partType: document.getElementById('mobilePartType')?.value || '',
                    externalStandard: document.getElementById('mobileExternalStandard')?.value || '',
                    sStandard: document.getElementById('mobileSStandard')?.value || AUDIT_TYPES[currentAuditType]?.norm || '',
                    workInstruction: document.getElementById('mobileWorkInstruction')?.value || AUDIT_TYPES[currentAuditType]?.instruction || ''
                };
            } else {
                return {
                    operatorName: document.getElementById('operatorName')?.value || '',
                    operatorNumber: document.getElementById('operatorNumber')?.value || '',
                    operatorCert: document.getElementById('operatorCert')?.value || '',
                    operatorDept: document.getElementById('operatorDept')?.value || '',
                    auditorName: document.getElementById('auditorName')?.value || '',
                    auditorDept: document.getElementById('auditorDept')?.value || '',
                    auditorCert: document.getElementById('auditorCert')?.value || '',
                    auditorPhone: document.getElementById('auditorPhone')?.value || '',
                    approverName: document.getElementById('approverName')?.value || '',
                    approverDept: document.getElementById('approverDept')?.value || '',
                    approverCert: document.getElementById('approverCert')?.value || '',
                    approverPhone: document.getElementById('approverPhone')?.value || '',
                    reportNumber: document.getElementById('reportNumber')?.value || '',
                    partType: document.getElementById('partType')?.value || '',
                    externalStandard: document.getElementById('externalStandard')?.value || '',
                    sStandard: document.getElementById('sStandard')?.value || AUDIT_TYPES[currentAuditType]?.norm || '',
                    workInstruction: document.getElementById('workInstruction')?.value || AUDIT_TYPES[currentAuditType]?.instruction || ''
                };
            }
        }

        function setHeaderData(data) {
            if (!data) return;
            
            // Setze alle Felder
            const fields = [
                { id: 'operatorName', value: data.operatorName },
                { id: 'operatorNumber', value: data.operatorNumber },
                { id: 'operatorCert', value: data.operatorCert },
                { id: 'operatorDept', value: data.operatorDept },
                { id: 'auditorName', value: data.auditorName },
                { id: 'auditorDept', value: data.auditorDept },
                { id: 'auditorCert', value: data.auditorCert },
                { id: 'auditorPhone', value: data.auditorPhone },
                { id: 'approverName', value: data.approverName },
                { id: 'approverDept', value: data.approverDept },
                { id: 'approverCert', value: data.approverCert },
                { id: 'approverPhone', value: data.approverPhone },
                { id: 'reportNumber', value: data.reportNumber },
                { id: 'partType', value: data.partType },
                { id: 'externalStandard', value: data.externalStandard },
                { id: 'sStandard', value: data.sStandard },
                { id: 'workInstruction', value: data.workInstruction }
            ];
            
            fields.forEach(field => {
                const element = document.getElementById(field.id);
                const mobileElement = document.getElementById('mobile' + field.id.charAt(0).toUpperCase() + field.id.slice(1));
                
                if (element && field.value !== undefined) element.value = field.value;
                if (mobileElement && field.value !== undefined) mobileElement.value = field.value;
            });
        }

        function startAudit(auditType) {
            currentAuditType = auditType;
            
            document.getElementById('auditSelection').classList.remove('active');
            document.getElementById('auditContent').classList.add('active');
            document.getElementById('finalResult').style.display = 'none';
            
            loadCurrentAuditData();
            
            const auditInfo = AUDIT_TYPES[auditType];
            document.querySelector('h1').textContent = `ZfP Audit - ${auditInfo.title}`;
            document.querySelector('.subtitle').textContent = `Pr√ºfverfahren: ${auditInfo.title}`;
            
            // Reset Header States
            document.getElementById('desktopHeaderContent').classList.remove('collapsed');
            document.getElementById('desktopToggleHeader').textContent = 'Ausblenden';
            document.getElementById('mobileHeaderSection').classList.add('collapsed');
            document.getElementById('mobileHeaderContent').classList.add('collapsed');
            document.getElementById('mobileToggleHeader').textContent = 'Einblenden';
            
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                document.getElementById('desktopView').style.display = 'none';
                document.getElementById('mobileView').style.display = 'block';
                document.getElementById('toggleViewBtn').textContent = 'üñ•Ô∏è Desktop';
                renderMobileQuestion();
            } else {
                document.getElementById('desktopView').style.display = 'block';
                document.getElementById('mobileView').style.display = 'none';
                document.getElementById('toggleViewBtn').textContent = 'üì± Mobile';
                renderAuditSections();
            }
            
            updateCurrentAuditProgress();
            checkAndShowFinalResult();
        }

        function loadCurrentAuditData() {
            const saved = localStorage.getItem(`zfpAudit_${currentAuditType}`);
            if (saved) {
                currentAuditData = JSON.parse(saved);
                allQuestions = currentAuditData.questions || [];
                imageStorage = currentAuditData.images || {};
                
                if (currentAuditData.headerData) {
                    setHeaderData(currentAuditData.headerData);
                }
                
                uploadedImages.clear();
                allQuestions.forEach(question => {
                    if (question.images && question.images.length > 0) {
                        question.images.forEach(img => {
                            uploadedImages.add(img);
                        });
                    }
                });
            } else {
                const sections = STANDARD_QUESTIONS[currentAuditType];
                allQuestions = sections.flatMap(section => 
                    section.questions.map(q => ({
                        ...q,
                        sectionTitle: section.title,
                        sectionShort: section.short,
                        verdict: null,
                        comment: "",
                        images: []
                    }))
                );
                
                currentAuditData = {
                    meta: {
                        created: new Date().toISOString(),
                        lastModified: new Date().toISOString(),
                        auditType: currentAuditType,
                        title: AUDIT_TYPES[currentAuditType].title,
                        version: "2.5"
                    },
                    headerData: {},
                    questions: allQuestions,
                    images: {}
                };
            }
        }

        function saveCurrentAuditData() {
            if (!currentAuditType || !currentAuditData) return;
            
            currentAuditData.questions = allQuestions;
            currentAuditData.headerData = getHeaderData();
            currentAuditData.images = imageStorage;
            currentAuditData.meta.lastModified = new Date().toISOString();
            
            localStorage.setItem(`zfpAudit_${currentAuditType}`, JSON.stringify(currentAuditData));
            updateAuditProgressDisplays();
            updateCurrentAuditProgress();
            checkAndShowFinalResult();
        }

        async function goBackToSelection() {
            saveCurrentAuditData();
            
            const shouldProceed = await showCustomModal('Zur√ºck zur Auswahl? Ungespeicherte √Ñnderungen gehen verloren.');
            if (!shouldProceed) return;
            
            currentAuditType = null;
            currentAuditData = null;
            allQuestions = [];
            uploadedImages.clear();
            
            document.getElementById('auditSelection').classList.add('active');
            document.getElementById('auditContent').classList.remove('active');
            
            document.querySelector('h1').textContent = 'ZfP Operator Audit';
            document.querySelector('.subtitle').textContent = 'Zerst√∂rungsfreie Pr√ºfverfahren - Operator Qualifizierung';
        }

        // === FORTSCHRITTSANZEIGEN ===
        function updateAuditProgressDisplays() {
            Object.keys(AUDIT_TYPES).forEach(auditType => {
                const progress = calculateAuditProgress(auditType);
                const progressElement = document.getElementById(`${auditType}Progress`);
                if (progressElement) {
                    progressElement.textContent = `${progress.percent}%`;
                }
            });
        }

        function calculateAuditProgress(auditType) {
            const saved = localStorage.getItem(`zfpAudit_${auditType}`);
            if (!saved) {
                const sections = STANDARD_QUESTIONS[auditType];
                const total = sections.reduce((sum, section) => sum + section.questions.length, 0);
                return { answered: 0, total: total, percent: 0, ok: 0, notOk: 0 };
            }
            
            const data = JSON.parse(saved);
            const questions = data.questions || [];
            const total = questions.length;
            const answered = questions.filter(q => q.verdict !== null).length;
            const ok = questions.filter(q => q.verdict === 'ok').length;
            const notOk = questions.filter(q => q.verdict === 'not-ok').length;
            const percent = total > 0 ? Math.round((answered / total) * 100) : 0;
            
            return { answered, total, percent, ok, notOk };
        }

        function updateCurrentAuditProgress() {
            if (!allQuestions.length) return;
            
            const total = allQuestions.length;
            const answered = allQuestions.filter(q => q.verdict !== null).length;
            const ok = allQuestions.filter(q => q.verdict === 'ok').length;
            const notOk = allQuestions.filter(q => q.verdict === 'not-ok').length;
            const percent = total > 0 ? Math.round((answered / total) * 100) : 0;
            
            // Update Fortschrittsbalken
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressText').textContent = `${percent}%`;
            
            // Update Status-Text
            let statusText = "In Bearbeitung";
            let statusColor = "#f39c12";
            
            if (answered === total) {
                const activityProofQuestion = allQuestions.find(q => q.isActivityProof);
                const activityProofOk = activityProofQuestion && activityProofQuestion.verdict === 'ok';
                
                if (notOk === 0 && activityProofOk) {
                    statusText = "‚úÖ Bestanden";
                    statusColor = "#27ae60";
                } else if (notOk === 0 && !activityProofOk) {
                    statusText = "‚ö†Ô∏è T√§tigkeitsnachweis fehlt";
                    statusColor = "#f39c12";
                } else {
                    statusText = "‚ùå Nicht bestanden";
                    statusColor = "#e74c3c";
                }
            } else if (answered > 0) {
                statusText = `${answered}/${total} beantwortet`;
            }
            
            document.getElementById('auditStatusText').textContent = statusText;
            document.getElementById('auditStatusText').style.color = statusColor;
            
            if (currentAuditType) {
                updateAuditProgressDisplays();
            }
        }

        // === RENDERING FUNKTIONEN ===
        function renderAuditSections() {
            const container = document.getElementById('auditSections');
            container.innerHTML = '';
            
            if (!allQuestions.length) return;
            
            const sections = {};
            allQuestions.forEach(question => {
                if (!sections[question.sectionTitle]) {
                    sections[question.sectionTitle] = {
                        title: question.sectionTitle,
                        short: question.sectionShort,
                        questions: []
                    };
                }
                sections[question.sectionTitle].questions.push(question);
            });
            
            Object.values(sections).forEach(section => {
                const sectionElement = document.createElement('div');
                sectionElement.className = 'section';
                sectionElement.innerHTML = `
                    <div class="section-header">
                        <h2>${section.title}</h2>
                        <span>‚ñº</span>
                    </div>
                    <div class="section-content">
                        ${renderSectionQuestions(section.questions, false)}
                    </div>
                `;
                container.appendChild(sectionElement);
            });
        }

        function renderSectionQuestions(questions, isMobile) {
            return questions.map(question => {
                const verdict = question.verdict;
                const questionClass = verdict === 'ok' ? 'ok' : verdict === 'not-ok' ? 'not-ok' : '';
                const images = question.images || [];
                const isActivityProof = question.isActivityProof || false;
                
                return `
                <div class="question ${questionClass}" data-id="${question.id}">
                    <div class="question-header">
                        <div class="question-text">${question.text} ${isActivityProof ? '<span style="color: #e74c3c; font-size: 0.8em;">‚ö†Ô∏è Erforderlich f√ºr Autorisierung</span>' : ''}</div>
                        <div class="question-id">${question.id}</div>
                    </div>
                    ${question.english ? `<div class="english-translation">${question.english}</div>` : ''}
                    
                    <div class="verdict-options">
                        <button class="verdict-btn ok ${verdict === 'ok' ? 'selected' : ''}" data-verdict="ok">
                            <span>‚úÖ</span> OK
                        </button>
                        <button class="verdict-btn not-ok ${verdict === 'not-ok' ? 'selected' : ''}" data-verdict="not-ok">
                            <span>‚ùå</span> Nicht OK
                        </button>
                    </div>
                    
                    <div class="comment-section">
                        <label class="comment-label">Kommentar:</label>
                        <textarea class="comment" placeholder="Anmerkungen...">${question.comment || ''}</textarea>
                    </div>
                    
                    ${!isMobile ? `
                    <div class="image-upload-section">
                        <h4>üì∏ Bildnachweise (optional)</h4>
                        <div class="file-input-wrapper">
                            <input type="file" accept="image/*" class="file-input image-input" multiple data-question="${question.id}">
                            <span class="file-input-label">Bilder ausw√§hlen</span>
                        </div>
                        <div class="image-preview-container" id="preview-${question.id}">
                            ${renderImagePreviews(images, question.id, isMobile)}
                        </div>
                    </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }

        function renderImagePreviews(images, questionId, isMobile) {
            return images.map((img, index) => `
                <div class="image-preview-item">
                    <img class="image-preview" src="${img}" alt="Bild ${index + 1}">
                    <button class="remove-image" data-question="${questionId}" data-index="${index}">√ó</button>
                </div>
            `).join('');
        }

        // === MOBILE FUNKTIONEN ===
        function renderMobileQuestion() {
            if (allQuestions.length === 0) return;
            
            const container = document.getElementById('mobileQuestions');
            const question = allQuestions[currentMobileQuestion];
            if (!question) return;
            
            const verdict = question.verdict;
            const questionClass = verdict === 'ok' ? 'ok' : verdict === 'not-ok' ? 'not-ok' : '';
            const images = question.images || [];
            const isActivityProof = question.isActivityProof || false;
            
            container.innerHTML = `
                <div class="question ${questionClass}" data-id="${question.id}">
                    <div class="question-header">
                        <div class="question-text">${question.text} ${isActivityProof ? '<span style="color: #e74c3c; font-size: 0.7em;">‚ö†Ô∏è Erforderlich</span>' : ''}</div>
                        <div class="question-id">${question.id}</div>
                    </div>
                    ${question.english ? `<div class="english-translation">${question.english}</div>` : ''}
                    
                    <div class="verdict-options">
                        <button class="verdict-btn ok ${verdict === 'ok' ? 'selected' : ''}" data-verdict="ok">
                            <span>‚úÖ</span> OK
                        </button>
                        <button class="verdict-btn not-ok ${verdict === 'not-ok' ? 'selected' : ''}" data-verdict="not-ok">
                            <span>‚ùå</span> Nicht OK
                        </button>
                    </div>
                    
                    <div class="comment-section">
                        <label class="comment-label">Kommentar:</label>
                        <textarea class="comment" placeholder="Anmerkungen..." rows="2">${question.comment || ''}</textarea>
                    </div>
                    
                    <div class="image-upload-section">
                        <h4>üì∏ Bilder (optional)</h4>
                        <div class="file-input-wrapper">
                            <input type="file" accept="image/*" class="file-input image-input" multiple data-question="${question.id}">
                            <span class="file-input-label">Bilder ausw√§hlen</span>
                        </div>
                        <div class="image-preview-container" id="mobile_preview-${question.id}">
                            ${renderImagePreviews(images, question.id, true)}
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('mobileCounter').textContent = `${currentMobileQuestion + 1}/${allQuestions.length}`;
            renderMobileSectionSelector();
        }

        function renderMobileSectionSelector() {
            const container = document.getElementById('sectionSelector');
            container.innerHTML = '';
            
            if (!allQuestions.length) return;
            
            const sections = {};
            let questionIndex = 0;
            
            allQuestions.forEach((question, index) => {
                if (!sections[question.sectionTitle]) {
                    sections[question.sectionTitle] = {
                        title: question.sectionTitle,
                        short: question.sectionShort,
                        startIndex: index,
                        count: 0
                    };
                }
                sections[question.sectionTitle].count++;
            });
            
            Object.values(sections).forEach((section, index) => {
                const button = document.createElement('button');
                button.className = 'section-btn';
                if (currentMobileQuestion >= section.startIndex && 
                    currentMobileQuestion < section.startIndex + section.count) {
                    button.classList.add('active');
                }
                button.textContent = section.short;
                button.title = section.title;
                button.addEventListener('click', function() {
                    currentMobileQuestion = section.startIndex;
                    renderMobileQuestion();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
                container.appendChild(button);
            });
        }

        // === HELPER FUNKTIONEN ===
        function updateQuestionData(questionId, field, value) {
            const question = allQuestions.find(q => q.id === questionId);
            if (question) {
                if (field === 'verdict') {
                    question.verdict = value;
                } else if (field === 'comment') {
                    question.comment = value;
                } else if (field === 'addImage') {
                    if (!question.images) question.images = [];
                    if (!uploadedImages.has(value)) {
                        question.images.push(value);
                        uploadedImages.add(value);
                        imageStorage[`${questionId}_${question.images.length}`] = value;
                    }
                } else if (field === 'removeImage') {
                    if (question.images) {
                        const removedImage = question.images[value];
                        question.images.splice(value, 1);
                        uploadedImages.delete(removedImage);
                        delete imageStorage[`${questionId}_${value}`];
                    }
                }
                saveCurrentAuditData();
                updateCurrentAuditProgress();
            }
        }
        // === HELPER FUNKTIONEN F√úR FOOTER ===
        function getDocumentNameForAudit(auditType) {
            const documentMap = {
                'wirbelstrom': 'FBL_INFSW17008_01_NDT_Personal_ET',
                'magnetpulver': 'FBL_INFSW17008_04_NDT_Personal_MT', 
                'nital': 'FBL_INFSW17008_03_NDT_Personal_NE',
                'ultraschall': 'FBL_INFSW17008_02_NDT_Personal_UT'
            };
            return documentMap[auditType] || 'FBL_INFSW17008_NDT_Personal';
        }

        function getVersionForAudit(auditType) {
            return 'Version AA, 16.12.2025';
        }

        // === BILDVERARBEITUNG ===
        async function processAndLimitImage(file) {
            return new Promise((resolve, reject) => {
                const maxSize = 5 * 1024 * 1024;
                if (file.size > maxSize) {
                    reject(new Error(`Bild zu gro√ü (${(file.size / 1024 / 1024).toFixed(1)}MB). Max: 5MB`));
                    return;
                }

                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = function() {
                    const maxWidth = 1200;
                    const maxHeight = 800;
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = Math.floor(width * ratio);
                        height = Math.floor(height * ratio);
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, width, height);
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    try {
                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8);
                        resolve(compressedDataUrl);
                    } catch (error) {
                        reject(new Error('Bild konnte nicht verarbeitet werden'));
                    }
                };
                
                img.onerror = function() {
                    reject(new Error('Bild konnte nicht geladen werden'));
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        async function handleImageUpload(event, questionId, isMobile = false) {
            const files = Array.from(event.target.files);
            if (!files.length) return;
            
            event.target.value = '';
            
            const question = allQuestions.find(q => q.id === questionId);
            if (!question.images) question.images = [];
            
            const previewContainerId = isMobile ? `mobile_preview-${questionId}` : `preview-${questionId}`;
            const previewContainer = document.getElementById(previewContainerId);
            
            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    showCustomModal('‚ùå Nur Bilddateien erlaubt');
                    continue;
                }
                
                try {
                    const compressedImage = await processAndLimitImage(file);
                    
                    if (uploadedImages.has(compressedImage)) {
                        showCustomModal('‚ö†Ô∏è Dieses Bild wurde bereits hochgeladen');
                        continue;
                    }
                    
                    updateQuestionData(questionId, 'addImage', compressedImage);
                    
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img class="image-preview" src="${compressedImage}" alt="Bild">
                        <button class="remove-image" data-question="${questionId}" data-index="${question.images.length - 1}">√ó</button>
                    `;
                    previewContainer.appendChild(previewItem);
                    
                } catch (error) {
                    showCustomModal(`‚ùå ${error.message}`);
                }
            }
            
            saveCurrentAuditData();
        }

        function removeImage(questionId, imageIndex, isMobile = false) {
            const question = allQuestions.find(q => q.id === questionId);
            if (question && question.images) {
                updateQuestionData(questionId, 'removeImage', imageIndex);
                
                if (isMobile) {
                    renderMobileQuestion();
                } else {
                    const questionElement = document.querySelector(`.question[data-id="${questionId}"]`);
                    if (questionElement) {
                        const previewContainer = questionElement.querySelector('.image-preview-container');
                        if (previewContainer) {
                            previewContainer.innerHTML = renderImagePreviews(question.images, questionId, false);
                        }
                    }
                }
            }
        }

        // === ERGEBNISANZEIGE ===
        function checkAndShowFinalResult() {
            if (!allQuestions.length) return;
            
            const total = allQuestions.length;
            const answered = allQuestions.filter(q => q.verdict !== null).length;
            const notOk = allQuestions.filter(q => q.verdict === 'not-ok').length;
            
            if (answered === total) {
                const finalResult = document.getElementById('finalResult');
                const resultIcon = document.getElementById('resultIcon');
                const resultText = document.getElementById('resultText');
                
                const activityProofQuestion = allQuestions.find(q => q.isActivityProof);
                const activityProofOk = activityProofQuestion && activityProofQuestion.verdict === 'ok';
                
                if (notOk === 0 && activityProofOk) {
                    finalResult.className = 'final-result passed';
                    resultIcon.textContent = '‚úÖ';
                    resultText.textContent = 'Audit BESTANDEN - T√§tigkeitsnachweis vorhanden';
                } else if (notOk === 0 && !activityProofOk) {
                    finalResult.className = 'final-result warning';
                    resultIcon.textContent = '‚ö†Ô∏è';
                    resultText.textContent = 'T√§tigkeitsnachweis erforderlich f√ºr Autorisierung';
                } else {
                    finalResult.className = 'final-result failed';
                    resultIcon.textContent = '‚ùå';
                    resultText.textContent = 'Audit NICHT BESTANDEN';
                }
                
                finalResult.style.display = 'block';
            } else {
                document.getElementById('finalResult').style.display = 'none';
            }
        }

        // === BERICHTSANZEIGE ===
        async function showReport() {
            saveCurrentAuditData();
            
            const headerData = getHeaderData();
            const auditInfo = AUDIT_TYPES[currentAuditType];
            const now = new Date();
            
            const total = allQuestions.length;
            const answered = allQuestions.filter(q => q.verdict !== null).length;
            const notOk = allQuestions.filter(q => q.verdict === 'not-ok').length;
            const activityProofQuestion = allQuestions.find(q => q.isActivityProof);
            const activityProofOk = activityProofQuestion && activityProofQuestion.verdict === 'ok';
            
            let reportHTML = `
                <div class="report-header" style="position: relative;">
                    <!-- LOGO OBEN RECHTS -->
                    <div style="position: absolute; top: -5px; right: 1px; text-align: right;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/7/72/Schaeffler_logo.svg" 
                             alt="Schaeffler Logo" 
                             style="height: 7mm; width: auto; max-width: 35mm;">
                    </div>
                    
                    <h2>ZfP-Operator Audit</h2>
                    <div class="company-info"><strong>Pr√ºfbericht-Nr.:</strong> ${headerData.reportNumber || 'Muster_2025_NE'}</div>
                </div>
                
                <!-- PERSONEN -->
                <table class="person-table">
                    <thead>
                        <tr>
                            <th style="width: 33%;">Bediener / Operator</th>
                            <th style="width: 33%;">Level II Auditor</th>
                            <th style="width: 34%;">Freigegeben Stufe III</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <strong>Name:</strong> ${headerData.operatorName || '---'}<br>
                                <strong>Mitarbeiter-Nr.:</strong> ${headerData.operatorNumber || '---'}<br>
                                <strong>Zertifikat:</strong> ${headerData.operatorCert || '---'}<br>
                                <strong>Abteilung:</strong> ${headerData.operatorDept || '---'}
                            </td>
                            <td>
                                <strong>Name:</strong> ${headerData.auditorName || '---'}<br>
                                <strong>Abteilung:</strong> ${headerData.auditorDept || '---'}<br>
                                <strong>Zertifikat:</strong> ${headerData.auditorCert || '---'}<br>
                                <strong>Tel:</strong> ${headerData.auditorPhone || '---'}
                            </td>
                            <td>
                                <strong>Name:</strong> ${headerData.approverName || '---'}<br>
                                <strong>Abteilung:</strong> ${headerData.approverDept || '---'}<br>
                                <strong>Zertifikat:</strong> ${headerData.approverCert || '---'}<br>
                                <strong>Tel:</strong> ${headerData.approverPhone || '---'}
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- PR√úFUNGSDETAILS -->
                <table class="details-table">
                    <tr>
                        <td><strong>F-Teiletype:</strong></td>
                        <td>${headerData.partType || '---'}</td>
                        <td><strong>Pr√ºfverfahren:</strong></td>
                        <td>${auditInfo.title}</td>
                    </tr>
                    <tr>
                        <td><strong>Externe Norm:</strong></td>
                        <td>${headerData.externalStandard || '---'}</td>
                        <td><strong>S-Standard:</strong></td>
                        <td>${headerData.sStandard || auditInfo.norm}</td>
                    </tr>
                    <tr>
                        <td><strong>Arbeitsanweisung:</strong></td>
                        <td colspan="3">${headerData.workInstruction || auditInfo.instruction}</td>
                    </tr>
                </table>
                
                <!-- AUDIT-ERGEBNISSE -->
                <div class="results-section">
                    <div class="report-section-header">Audit-Ergebnisse</div>
            `;
            
            const sections = {};
            allQuestions.forEach(question => {
                if (!sections[question.sectionTitle]) {
                    sections[question.sectionTitle] = [];
                }
                sections[question.sectionTitle].push(question);
            });
            
            Object.keys(sections).forEach(sectionTitle => {
                reportHTML += `<div class="report-section-header">${sectionTitle}</div>`;
                
                sections[sectionTitle].forEach(question => {
                    const verdictClass = question.verdict === 'ok' ? 'ok' : question.verdict === 'not-ok' ? 'not-ok' : '';
                    const verdictIcon = question.verdict === 'ok' ? '‚úÖ' : question.verdict === 'not-ok' ? '‚ùå' : '‚óã';
                    
                    reportHTML += `
                        <div class="question-item ${verdictClass}">
                            <span class="question-id">${question.id}:</span> ${verdictIcon} ${question.text}
                            ${question.comment ? `<div class="question-comment">Kommentar: ${question.comment}</div>` : ''}
                            ${renderQuestionImagesInReport(question)}
                        </div>
                    `;
                });
            });
            
            reportHTML += `
                </div>
                
                <!-- UNTERSCHRIFTEN OHNE LINIEN -->
                <div class="signature-area">
                    <div class="signature-box">
                        <div style="font-weight: bold; font-size: 11px;">Auditor (Level II)</div>
                        <div class="signature-line">
                            <!-- KEINE LINIE - NUR PLATZ F√úR UNTERSCHRIFT -->
                        </div>
                    </div>
                    
                    <div class="signature-box">
                        <div style="font-weight: bold; font-size: 11px;">NDT Expert (Level III)</div>
                        <div class="signature-line">
                            <!-- KEINE LINIE - NUR PLATZ F√úR UNTERSCHRIFT -->
                        </div>
                    </div>
                </div>
                <div style="font-size: 10px; text-align: center">
        <div>Erstellt: ${new Date().toLocaleDateString('de-DE')} ${new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'})}</div>
        <div>N√§chste Pr√ºfung f√§llig: ${new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toLocaleDateString('de-DE')}</div>
                
                <!-- FOOTER -->
                <div style="font-size: 10px; color: #666; text-align: center; border-top: 1px solid #ccc; padding-top: 8px;">
                    <table style="width: 100%;">
                        <tr>
                            <td style="text-align: left; width: 33%;">Daniel H√§usner, WI/SW2-PQT</td>
                            <td style="text-align: center; width: 34%;">
                                <div style="word-break: break-word; max-width: 180px; margin: 0 auto; font-size: 9px;">
                                    ${getDocumentNameForAudit(currentAuditType)}
                                </div>
                            </td>
                            <td style="text-align: right; width: 33%;">${getVersionForAudit(currentAuditType)}</td>
                        </tr>
                    </table>
                </div>
            `;
            
            document.getElementById('reportContainer').innerHTML = `
                <div class="report-action-buttons">
                    <button class="report-action-btn print-btn" onclick="printFullReport()">üñ®Ô∏è</button>
                    <button class="report-action-btn close-btn" onclick="closeReport()">‚úï</button>
                </div>
                ${reportHTML}
            `;
            document.getElementById('reportOverlay').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Neue Hilfsfunktion: Bilder zu einer Frage im Bericht rendern (GR√ñ√üER)
        function renderQuestionImagesInReport(question) {
            if (!question.images || question.images.length === 0) {
                return '';
            }
            
            let imagesHTML = '<div style="margin-top: 10px;">';
            imagesHTML += '<div style="display: flex; flex-wrap: wrap; gap: 15px;">';
            
            question.images.forEach((image, index) => {
                imagesHTML += `
                    <div style="border: 1px solid #ccc; padding: 5px; background: white; text-align: center;">
                        <img src="${image}" 
                             alt="" 
                             style="max-width: 300px; max-height: 300px; object-fit: contain; display: block;">
                    </div>
                `;
            });
            
            imagesHTML += '</div></div>';
            return imagesHTML;
        }

        async function showAuthorization() {
            // Speichere erst das aktuelle Audit
            saveCurrentAuditData();
            
            // Pr√ºfe alle Audit-Typen, welche bestanden sind
            const passedAudits = [];
            const allProcedures = [];
            
            for (const auditType of Object.keys(AUDIT_TYPES)) {
                const saved = localStorage.getItem(`zfpAudit_${auditType}`);
                if (saved) {
                    const auditData = JSON.parse(saved);
                    const questions = auditData.questions || [];
                    
                    if (questions.length > 0) {
                        const total = questions.length;
                        const answered = questions.filter(q => q.verdict !== null).length;
                        const notOk = questions.filter(q => q.verdict === 'not-ok').length;
                        const activityProofQuestion = questions.find(q => q.isActivityProof);
                        const activityProofOk = activityProofQuestion && activityProofQuestion.verdict === 'ok';
                        
                        // Audit ist bestanden, wenn alle Fragen beantwortet sind,
                        // keine "nicht OK" Bewertungen vorhanden sind
                        // UND der T√§tigkeitsnachweis vorhanden ist (OK)
                        if (answered === total && notOk === 0 && activityProofOk) {
                            // Bestimmte das Audit-Datum (aus meta.created oder jetzt)
                            let auditDate = new Date();
                            if (auditData.meta && auditData.meta.created) {
                                try {
                                    auditDate = new Date(auditData.meta.created);
                                } catch (e) {
                                    auditDate = new Date();
                                }
                            }
                            
                            // Berechne das Ablaufdatum (12 Monate sp√§ter)
                            const expiryDate = new Date(auditDate);
                            expiryDate.setMonth(expiryDate.getMonth() + 12);
                            
                            passedAudits.push({
                                type: auditType,
                                data: auditData,
                                info: AUDIT_TYPES[auditType],
                                auditDate: auditDate,
                                expiryDate: expiryDate,
                                reportNumber: auditData.headerData?.reportNumber || '---',
                                operatorCert: auditData.headerData?.operatorCert || '---'
                            });
                        }
                        
                        allProcedures.push({
                            type: auditType,
                            title: AUDIT_TYPES[auditType].title,
                            short: AUDIT_TYPES[auditType].short,
                            passed: (answered === total && notOk === 0 && activityProofOk)
                        });
                    }
                }
            }
            
            // Wenn keine Audits bestanden sind
            if (passedAudits.length === 0) {
                let message = 'Keine bestandenen Audits gefunden.\n\n';
                allProcedures.forEach(proc => {
                    message += `${proc.title}: ${proc.passed ? '‚úÖ Bestanden' : '‚ùå Nicht bestanden'}\n`;
                });
                message += '\nAutorisierung nur m√∂glich, wenn:\n1. Alle Fragen beantwortet sind\n2. Keine "Nicht OK" Bewertungen\n3. T√§tigkeitsnachweis vorhanden ist';
                
                showCustomModal(message);
                return;
            }
            
            // Finde das √ÑLTESTE Audit-Datum f√ºr die Gesamtg√ºltigkeit
            const oldestAuditDate = passedAudits.reduce((oldest, audit) => {
                return audit.auditDate < oldest ? audit.auditDate : oldest;
            }, passedAudits[0].auditDate);
            
            // Berechne Gesamt-Ablaufdatum (12 Monate nach √§ltestem Audit)
            const overallExpiryDate = new Date(oldestAuditDate);
            overallExpiryDate.setMonth(overallExpiryDate.getMonth() + 12);
            
            // Hole Header-Daten aus dem ERSTEN bestandenen Audit
            const headerData = passedAudits[0].data.headerData || {};
            
            // Sammle alle eindeutigen Zertifikatsnummern
            const uniqueCerts = [...new Set(passedAudits.map(a => a.operatorCert).filter(cert => cert && cert !== '---'))];
            
            let werk = '';
            if (headerData.operatorDept) {
                if (headerData.operatorDept.includes('SW1') || headerData.operatorDept.includes('WI/SW1')) {
                    werk = 'Werk 1';
                } else if (headerData.operatorDept.includes('SW2') || headerData.operatorDept.includes('WI/SW2')) {
                    werk = 'Werk 2';
                }
            }
            
            const authorizationText = `<strong>Die genannte Person hat nachweislich die in der Verfahrensanweisung 
INFSW17008 beschriebenen Voraussetzungen f√ºr Ausbildung, Schulung 
Berufserfahrung, fortlaufende T√§tigkeit und Pr√ºfung erf√ºllt und ist damit f√ºr die 
Durchf√ºhrung der Pr√ºfung in den oben gelisteten ZfP-Verfahren autorisiert. Die Autorisierung gilt nur in Verbindung mit einem g√ºltigen Zertifikat und hat
eine G√ºltigkeit von 12 Monaten.</strong><br><br><em>The named person has demonstrably fulfilled the requirements for training, education, professional experience, ongoing activity, and examination described in the procedure instruction INFSW17008 and is therefore authorized to conduct the examination in the NDT procedures listed below. This authorization is valid only in conjunction with a valid certificate and is valid for 12 months.</em>`;
            
            let authorizationHTML = `
                <div class="authorization-header">
                    <!-- LOGO OBEN RECHTS -->
                    <div style="position: absolute; top: -5px; right: 1px; text-align: right;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/7/72/Schaeffler_logo.svg" 
                             alt="Schaeffler Logo" 
                             style="height: 7mm; width: auto; max-width: 40mm;">
                    </div>
                    
                    <h1>AUTORISIERUNG</h1>
                    <div class="company-info">f√ºr zerst√∂rungsfreie Pr√ºfungen</div>
                </div>
                
                <div class="authorization-info">
                    <p><strong>Name:</strong> ${headerData.operatorName || '---'}</p>
                    <p><strong>Personalnummer:</strong> ${headerData.operatorNumber || '---'}</p>
                    <p><strong>Abteilung:</strong> ${headerData.operatorDept || '---'}</p>
                    <p><strong>Zertifikate:</strong> ${uniqueCerts.length > 0 ? uniqueCerts.join(', ') : '---'}</p>
                    <p><strong>Autorisierte Verfahren:</strong> ${passedAudits.map(a => `${a.info.title} (${a.info.short})`).join(', ')}</p>
                    <p><strong>Sektor:</strong> is</p>
                </div>
                
                <div class="authorization-text-box">
                    ${authorizationText}
                </div>
                
                <div class="authorization-details">
                    <p><strong>Befugnisse:</strong> Autorisierung zur Durchf√ºhrung folgender Verfahren:</p>
                    <div style="margin-left: 20px; margin-top: 5px;">
                        ${passedAudits.map(a => 
                            `<div style="margin-bottom: 3px;">‚Ä¢ ${a.info.title} (${a.info.short})</div>`
                        ).join('')}
                    </div>
                    
                    <p style="margin-top: 15px;"><strong>Ort:</strong> ${werk || 'Dem zust√§ndigen Werk'}</p>
                    <p><strong>Gesamtg√ºltigkeit:</strong> ${overallExpiryDate.toLocaleDateString('de-DE')}</p>
                </div>
                
                <!-- UNTERSCHRIFTEN - WIE IM BERICHTSFORMULAR -->
                <div class="authorization-signatures">
                    <div class="authorization-signature-field">
                        <div style="font-weight: bold; margin-bottom: 10px; font-size: 11px;">Autorisierter Mitarbeiter (oder F√ºhrungskraft)</div>
                        <div class="authorization-signature-line">
                            <div style="min-height: 20px;"></div>
                        </div>
                    </div>
                    
                    <div class="authorization-signature-field">
                        <div style="font-weight: bold; margin-bottom: 10px; font-size: 11px;">NDT Supervisor</div>
                        <div class="authorization-signature-line">
                        </div>
                    </div>
                </div>
                
                <!-- STAMP -->
                <div class="authorization-stamp-box">
                    <div>AUTORISIERUNG ERTEILT</div>
                    <div>${new Date().toLocaleDateString('de-DE')}</div>
                </div>
                
                <!-- FOOTER -->
                <div style="margin-top: 30px; font-size: 11px; color: #666; text-align: center; border-top: 1px solid #ccc; padding-top: 10px;">
                    <table style="width: 100%;">
                        <tr>
                            <td style="text-align: left; width: 33%;">Daniel H√§usner, WI/SW2-PQT</td>
                            <td style="text-align: center; width: 34%;">FBL_INFSW17008_05_Autorisierungen_ZfP_Pr√ºfungen</td>
                            <td style="text-align: right; width: 33%;">Version AA, 10.01.2026</td>
                        </tr>
                    </table>
                </div>
            `;
            
            document.getElementById('authorizationContainer').innerHTML = `
                <div class="report-action-buttons">
                    <button class="report-action-btn print-btn" onclick="printFullAuthorization()">üñ®Ô∏è</button>
                    <button class="report-action-btn close-btn" onclick="closeAuthorization()">‚úï</button>
                </div>
                ${authorizationHTML}
            `;
            document.getElementById('authorizationOverlay').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // === RESET FUNKTION ===
        async function resetAudit() {
            if (!currentAuditType) return;
            
            const shouldReset = await showCustomModal('Audit wirklich zur√ºcksetzen?\nALLE Daten werden gel√∂scht, inklusive Header-Felder.');
            if (!shouldReset) return;
            
            const sections = STANDARD_QUESTIONS[currentAuditType];
            allQuestions = sections.flatMap(section => 
                section.questions.map(q => ({
                    ...q,
                    sectionTitle: section.title,
                    sectionShort: section.short,
                    verdict: null,
                    comment: "",
                    images: []
                }))
            );
            
            resetAllHeaderFields();
            
            uploadedImages.clear();
            imageStorage = {};
            
            currentAuditData = {
                meta: {
                    created: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    auditType: currentAuditType,
                    title: AUDIT_TYPES[currentAuditType].title,
                    version: "2.5"
                },
                headerData: {},
                questions: allQuestions,
                images: {}
            };
            
            localStorage.setItem(`zfpAudit_${currentAuditType}`, JSON.stringify(currentAuditData));
            
            if (window.innerWidth <= 768) {
                currentMobileQuestion = 0;
                renderMobileQuestion();
            } else {
                renderAuditSections();
            }
            
            updateCurrentAuditProgress();
            document.getElementById('finalResult').style.display = 'none';
            
            showCustomModal('‚úÖ Audit wurde zur√ºckgesetzt\nALLE Felder wurden geleert.');
        }

        // === EXPORT FUNKTION ===
        async function exportAudit() {
            if (!currentAuditType || !currentAuditData) return;
            
            saveCurrentAuditData();
            
            const jsonData = { ...currentAuditData };
            const jsonBlob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const jsonUrl = URL.createObjectURL(jsonBlob);
            
            const jsonLink = document.createElement('a');
            jsonLink.href = jsonUrl;
            jsonLink.download = `ZfP_Audit_${AUDIT_TYPES[currentAuditType].title}_${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(jsonLink);
            jsonLink.click();
            document.body.removeChild(jsonLink);
            URL.revokeObjectURL(jsonUrl);
            
            const imageCount = Object.keys(imageStorage).length;
            if (imageCount > 0) {
                try {
                    let downloaded = 0;
                    
                    for (const [key, base64Data] of Object.entries(imageStorage)) {
                        const byteString = atob(base64Data.split(',')[1]);
                        const mimeString = base64Data.split(',')[0].split(':')[1].split(';')[0];
                        const ab = new ArrayBuffer(byteString.length);
                        const ia = new Uint8Array(ab);
                        
                        for (let i = 0; i < byteString.length; i++) {
                            ia[i] = byteString.charCodeAt(i);
                        }
                        
                        const blob = new Blob([ab], { type: mimeString });
                        const url = URL.createObjectURL(blob);
                        
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `Bild_${key}.jpg`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        downloaded++;
                        
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    showCustomModal(`‚úÖ Export erfolgreich\n\nJSON-Datei + ${downloaded} Bilder exportiert`);
                    
                } catch (error) {
                    showCustomModal(`‚úÖ JSON exportiert, aber Bilder konnten nicht exportiert werden:\n${error.message}`);
                }
            } else {
                showCustomModal('‚úÖ Audit wurde als JSON exportiert (keine Bilder vorhanden)');
            }
        }

        // === AUDIT LADEN FUNKTION ===
        function loadAudit() {
            document.getElementById('fileLoader').click();
        }

        function loadAuditData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    
                    if (!loadedData.meta || !loadedData.meta.auditType) {
                        throw new Error('Ung√ºltiges Audit-Datenformat');
                    }
                    
                    const auditType = loadedData.meta.auditType;
                    
                    if (currentAuditType !== auditType) {
                        startAudit(auditType);
                    }
                    
                    currentAuditData = loadedData;
                    allQuestions = currentAuditData.questions || [];
                    imageStorage = currentAuditData.images || {};
                    
                    uploadedImages.clear();
                    allQuestions.forEach(question => {
                        if (question.images && question.images.length > 0) {
                            question.images.forEach(img => {
                                uploadedImages.add(img);
                            });
                        }
                    });
                    
                    if (currentAuditData.headerData) {
                        setHeaderData(currentAuditData.headerData);
                    }
                    
                    localStorage.setItem(`zfpAudit_${auditType}`, JSON.stringify(currentAuditData));
                    
                    if (window.innerWidth <= 768) {
                        currentMobileQuestion = 0;
                        renderMobileQuestion();
                    } else {
                        renderAuditSections();
                    }
                    
                    updateCurrentAuditProgress();
                    checkAndShowFinalResult();
                    
                    showCustomModal(`‚úÖ Audit geladen\n\n${loadedData.meta.title}\nLetzte √Ñnderung: ${new Date(loadedData.meta.lastModified).toLocaleDateString()}`);
                    
                } catch (error) {
                    showCustomModal(`‚ùå Fehler beim Laden: ${error.message}`);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function toggleView() {
            const desktopView = document.getElementById('desktopView');
            const mobileView = document.getElementById('mobileView');
            const toggleBtn = document.getElementById('toggleViewBtn');
            
            if (desktopView.style.display === 'block') {
                desktopView.style.display = 'none';
                mobileView.style.display = 'block';
                toggleBtn.textContent = 'üñ•Ô∏è Desktop';
                renderMobileQuestion();
            } else {
                desktopView.style.display = 'block';
                mobileView.style.display = 'none';
                toggleBtn.textContent = 'üì± Mobile';
                renderAuditSections();
            }
        }

        function handleResize() {
            const isMobile = window.innerWidth <= 768;
            const desktopView = document.getElementById('desktopView');
            const mobileView = document.getElementById('mobileView');
            const toggleBtn = document.getElementById('toggleViewBtn');
            
            if (isMobile && desktopView.style.display === 'block') {
                desktopView.style.display = 'none';
                mobileView.style.display = 'block';
                toggleBtn.textContent = 'üñ•Ô∏è Desktop';
                renderMobileQuestion();
            } else if (!isMobile && mobileView.style.display === 'block') {
                desktopView.style.display = 'block';
                mobileView.style.display = 'none';
                toggleBtn.textContent = 'üì± Mobile';
                renderAuditSections();
            }
        }

        function loadQuestionsData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const questionsData = JSON.parse(e.target.result);
                    
                    if (typeof questionsData !== 'object') {
                        throw new Error('Ung√ºltiges Fragenformat');
                    }
                    
                    showCustomModal(`‚úÖ Fragen geladen\n\nVerfahren: ${Object.keys(questionsData).join(', ')}`);
                    
                } catch (error) {
                    showCustomModal(`‚ùå Fehler: ${error.message}`);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        // === OVERLAY CLOSE FUNKTIONEN ===
        function closeReport() {
            document.getElementById('reportOverlay').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        function closeAuthorization() {
            document.getElementById('authorizationOverlay').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    </script>
</body>
</html>

